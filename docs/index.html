<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Garden</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script>
    // Fallback if the main CDN fails
    if (typeof window.supabase === 'undefined') {
      console.log('Trying fallback CDN...');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js';
      script.onload = function() {
        console.log('Fallback CDN loaded successfully');
      };
      script.onerror = function() {
        console.error('Both CDNs failed to load');
      };
      document.head.appendChild(script);
    }
  </script>
  <style>
    body {
      font-family: 'Georgia', serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #f0e7ff 0%, #ffffff 100%);
      color: #4a4a4a;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
    .header {
      display: flex;
      justify-content: space-between;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px 15px;
    }
    .prompt, h2, p {
      margin: 10px 0;
    }
    h2 {
      font-size: 1.6rem;
      font-weight: 400;
      color: #6b4e9a;
      letter-spacing: 0.5px;
    }
    .prompt {
      font-size: 1.1rem;
      font-style: italic;
      color: #5c5c5c;
    }
    p {
      font-size: 0.95rem;
      color: #666;
    }
    .button {
      background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: 'Georgia', serif;
      font-weight: 400;
      letter-spacing: 1px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease-in-out;
    }
    .button:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    .button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    .floating-plus {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease-in-out;
      z-index: 1000;
    }
    .floating-plus:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
    .hidden { display: none; }
    input[type="text"], input[type="email"], input[type="password"], textarea {
      width: 90%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      margin: 10px 0;
      font-family: 'Georgia', serif;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    textarea { min-height: 130px; resize: vertical; }
    #history-list { width: 95%; }
    .history-item {
      text-align: left;
      padding: 15px;
      background: rgba(255, 255, 255, 0.95);
      margin: 8px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      cursor: pointer;
    }
    .history-item img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 10px;
    }
    .history-item button {
      margin: 4px;
      padding: 6px 14px;
      font-size: 0.85rem;
      border-radius: 20px;
      background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease-in-out;
    }
    .history-item button:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }
    img.preview {
      max-width: 90%;
      margin-top: 10px;
      display: none;
      border-radius: 12px;
    }
    #current-date {
      font-size: 1.1rem;
      font-weight: 400;
      color: #6b4e9a;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    #current-time {
      font-size: 0.9rem;
      font-weight: 300;
      color: #7c7c7c;
      letter-spacing: 0.5px;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 10px 0;
    }
    @media (max-width: 480px) {
      h2 { font-size: 1.4rem; }
      .prompt { font-size: 1rem; }
      p { font-size: 0.9rem; }
      .button { font-size: 0.85rem; padding: 8px 16px; }
      input[type="text"], input[type="email"], input[type="password"], textarea { width: 92%; padding: 10px; }
      .history-item { padding: 12px; }
      .floating-plus { width: 45px; height: 45px; font-size: 26px; }
    }
    .options-menu {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 10px;
      display: none;
      z-index: 999;
    }
    .options-menu button {
      display: block;
      width: 100%;
      margin: 5px 0;
      background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
      color: #fff;
      border: none;
      padding: 8px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
    }
    .options-menu button:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="header">
    <span id="current-time"></span>
    <div>
      <button id="auth-button" class="button hidden">Sign Out</button>
      <button id="debug-button" class="button" onclick="testAuthConnection()" style="margin-left: 10px; font-size: 0.8rem;">Debug Auth</button>
    </div>
  </div>
  <!-- Main Screen -->
  <div id="main-screen" class="content hidden">
    <div id="quote" class="prompt">The wound is the place where the light enters you. â€“ Rumi</div>
    <button class="button" onclick="newQuote()">Inspire Me</button>
    <h2>My Garden...</h2>
    <p>Tap the plus button to begin planning</p>
  </div>
  <!-- Registration Screen -->
  <div id="register-screen" class="content">
    <h2>Create Your Account</h2>
    <p>Sign up to save your reflections securely</p>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <div class="button-group">
      <button class="button" id="signup-button">Sign Up</button>
      <button class="button" onclick="showLoginScreen()">Log In</button>
      <button class="button" onclick="resendConfirmation()">Resend Email</button>
      <button class="button" onclick="goBack()">Back</button>
    </div>
    <p id="auth-message" class="prompt"></p>
  </div>
  <!-- Login Screen -->
  <div id="login-screen" class="content hidden">
    <h2>Log In</h2>
    <p>Access your saved reflections</p>
    <input type="email" id="login-email" placeholder="Email">
    <input type="password" id="login-password" placeholder="Password">
    <div class="button-group">
      <button class="button" id="login-button">Log In</button>
      <button class="button" onclick="showRegisterScreen()">Sign Up</button>
      <button class="button" onclick="handleForgotPassword()">Forgot Password?</button>
      <button class="button" onclick="goBack()">Back</button>
    </div>
    <p id="login-message" class="prompt"></p>
  </div>
  <!-- Entry Screen -->
  <div id="entry-screen" class="content hidden">
    <h2 id="current-date"></h2>
    <div id="reflection-question" class="prompt">What moment today felt like a gift from the universe?</div>
    <button class="button" onclick="newQuestion()">New Question</button>
    <input type="text" id="title" placeholder="Title">
    <textarea id="reflection" placeholder="Speak or type your reflections..."></textarea>
    <div>
      <input type="file" accept="image/*" id="image-input" capture="environment">
      <img id="preview-image" class="preview" src="" alt="Preview">
    </div>
    <div class="button-group">
      <button class="button" id="start-voice">Start Speaking</button>
      <button class="button" id="stop-voice" disabled>Stop Speaking</button>
      <button class="button" id="save" disabled>Save Reflection</button>
      <button class="button" onclick="goBack()">Back</button>
    </div>
  </div>
  <!-- History Screen -->
  <div id="history-screen" class="content hidden">
    <h2>Past Reflections</h2>
    <div id="history-list"></div>
    <div class="button-group">
      <button class="button" onclick="goBack()">Back</button>
    </div>
  </div>
  <div class="floating-plus" onclick="toggleOptionsMenu()">+</div>
  <div id="options-menu" class="options-menu">
    <button onclick="showEntryScreen()">New Seed</button>
    <button onclick="showHistory()">My Plants</button>
  </div>
  <script>
    // Initialize Supabase client
    let supabase;
    
    function initializeSupabase() {
      if (typeof window.supabase === 'undefined') {
        console.error('Supabase library not loaded');
        return false;
      }
      
      const supabaseUrl = 'https://ccdbajqwlwgduilomlmq.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZGJhanF3bHdnZHVpbG9tbG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTM0ODIsImV4cCI6MjA3MTk4OTQ4Mn0.Aa9mHZOgL1-EZjn1r_AYbharWttMhVV5zL19x0abnvU';
      
      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
          auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: true
          }
        });
        console.log('Supabase client initialized successfully');
        return true;
      } catch (error) {
        console.error('Failed to initialize Supabase client:', error);
        return false;
      }
    }

    let recognition;
    let reflections = [];
    let currentImage = "";
    let editingIndex = null;
    let user = null;

    const quotes = [
      "The wound is the place where the light enters you. â€“ Rumi",
      "We should write because humans are spiritual beings and writing is a powerful form of prayer and meditation. â€“ Gloria AnzaldÃºa",
      "Fill your paper with the breathings of your heart. â€“ William Wordsworth",
      "There is no way to happinessâ€”happiness is the way. â€“ Thich Nhat Hanh",
      "The present moment is filled with joy and happiness. If you are attentive, you will see it. â€“ Thich Nhat Hanh",
      "Breathing in, I calm my body. Breathing out, I smile. Dwelling in the present moment, I know this is a wonderful moment. â€“ Thich Nhat Hanh",
      "You do not need to know precisely what is happening, or exactly where it is all going. What you need is to recognize the possibilities and challenges offered by the present moment, and to embrace them with courage, faith, and hope. â€“ Thomas Merton",
      "Happiness is not a matter of intensity but of balance, order, rhythm and harmony. â€“ Thomas Merton",
      "Compassion is a verb. â€“ Thich Nhat Hanh",
      "When another person makes you suffer, it is because he suffers deeply within himself. He does not need punishment; he needs help. â€“ Thich Nhat Hanh",
      "Understanding is loveâ€™s other name. If you donâ€™t understand, you cannot love. â€“ Thich Nhat Hanh",
      "Love is our true destiny. We do not find the meaning of life by ourselves aloneâ€”we find it with another. â€“ Thomas Merton",
      "The biggest human temptation is to settle for too little love. â€“ Thomas Merton",
      "Our job is to love others without stopping to inquire whether or not they are worthy. â€“ Thomas Merton",
      "Sometimes your joy is the source of your smile, but sometimes your smile can be the source of your joy. â€“ Thich Nhat Hanh",
      "Walk as if you are kissing the Earth with your feet. â€“ Thich Nhat Hanh",
      "Because you are alive, everything is possible. â€“ Thich Nhat Hanh",
      "We are not at peace because we have not yet learned to be alone with ourselves. â€“ Thomas Merton",
      "Silence is the language of God, all else is poor translation. â€“ Thomas Merton",
      "The things we fear most in prayer are the things that can save us. â€“ Thomas Merton",
      "In the stillness of your soul, wisdom whispers its truths. â€“ Unknown",
      "Every step you take is a dance with the universeâ€™s rhythm. â€“ Unknown",
      "The heartâ€™s quiet moments hold the seeds of transformation. â€“ Unknown",
      "Embrace the shadows, for they guide you to your light. â€“ Unknown",
      "Your spirit blooms where gratitude takes root. â€“ Unknown"
    ];
    const journalQuestions = [
      "What moment today felt like a gift from the universe?",
      "How did you find peace in a challenging situation?",
      "What inspires your soul to create today?",
      "What is one thing youâ€™re grateful for right now?",
      "What vision for your future feels most alive?"
    ];

    function getRandomQuestion() {
      return journalQuestions[Math.floor(Math.random() * journalQuestions.length)];
    }

    function newQuote() {
      document.getElementById('quote').textContent =
        quotes[Math.floor(Math.random() * quotes.length)];
    }

    function newQuestion() {
      document.getElementById('reflection-question').textContent = getRandomQuestion();
    }

    function updateDateTime() {
      const now = new Date();
      const options = {
        weekday: 'long', month: 'short', day: 'numeric',
        year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
      };
      document.getElementById('current-date').textContent =
        now.toLocaleString('en-US', options).replace(',', '');
      document.getElementById('current-time').textContent =
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) + ' CDT';
    }

    async function loadReflections() {
      if (!user) return;
      
      try {
        const { data, error } = await supabase
          .from('reflections')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Error loading reflections:', error);
          // Fallback to localStorage if database fails
          const localReflections = localStorage.getItem('reflections');
          if (localReflections) {
            reflections = JSON.parse(localReflections);
            console.log('Using local reflections as fallback');
          } else {
            reflections = [];
          }
          return;
        }
        
        reflections = data || [];
        localStorage.setItem('reflections', JSON.stringify(reflections));
      } catch (err) {
        console.error('Unexpected error loading reflections:', err);
        // Fallback to localStorage
        const localReflections = localStorage.getItem('reflections');
        if (localReflections) {
          reflections = JSON.parse(localReflections);
        } else {
          reflections = [];
        }
      }
    }

    async function saveReflections() {
      if (!user) return;
      const title = document.getElementById('title').value.trim();
      const reflection = document.getElementById('reflection').value.trim();
      const date = document.getElementById('current-date').textContent;
      const reflectionData = {
        user_id: user.id,
        title,
        reflection,
        date,
        image: currentImage,
        created_at: new Date().toISOString()
      };

      try {
        if (editingIndex !== null && reflections[editingIndex]) {
          const { error } = await supabase
            .from('reflections')
            .update(reflectionData)
            .eq('id', reflections[editingIndex].id);
          if (error) {
            console.error('Error updating reflection:', error);
            // Fallback to local storage
            reflections[editingIndex] = { ...reflectionData, id: reflections[editingIndex].id || Date.now() };
          } else {
            reflections[editingIndex] = { ...reflectionData, id: reflections[editingIndex].id };
          }
        } else {
          const { data, error } = await supabase
            .from('reflections')
            .insert([reflectionData])
            .select();
          if (error) {
            console.error('Error saving reflection:', error);
            // Fallback to local storage
            const newReflection = { ...reflectionData, id: Date.now() };
            reflections.push(newReflection);
          } else {
            reflections.push(data[0]);
          }
        }
        
        localStorage.setItem('reflections', JSON.stringify(reflections));
        currentImage = "";
        editingIndex = null;
        goBack();
        alert("Reflection saved!");
      } catch (err) {
        console.error('Unexpected error saving reflection:', err);
        // Fallback to local storage only
        const newReflection = { ...reflectionData, id: Date.now() };
        reflections.push(newReflection);
        localStorage.setItem('reflections', JSON.stringify(reflections));
        currentImage = "";
        editingIndex = null;
        goBack();
        alert("Reflection saved locally!");
      }
    }

    function showRegisterScreen() {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.remove('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('auth-message').textContent = '';
    }

    function showLoginScreen() {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('login-message').textContent = '';
    }

    function showEntryScreen(index = null) {
      if (!user) {
        showRegisterScreen();
        document.getElementById('auth-message').textContent = 'Please sign up or log in to create reflections.';
        return;
      }
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.remove('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('title').value = '';
      document.getElementById('reflection').value = '';
      document.getElementById('image-input').value = '';
      document.getElementById('preview-image').src = '';
      document.getElementById('preview-image').style.display = 'none';
      currentImage = "";
      editingIndex = index;
      if (index !== null && reflections[index]) {
        document.getElementById('title').value = reflections[index].title;
        document.getElementById('reflection').value = reflections[index].reflection;
        if (reflections[index].image) {
          document.getElementById('preview-image').src = reflections[index].image;
          document.getElementById('preview-image').style.display = 'block';
          currentImage = reflections[index].image;
        }
      }
      document.getElementById('save').disabled = !canSave();
      document.getElementById('start-voice').disabled = false;
      document.getElementById('stop-voice').disabled = true;
      newQuestion();
      updateDateTime();
    }

    function goBack() {
      if (recognition) recognition.stop();
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('main-screen').classList.remove('hidden');
      editingIndex = null;
    }

    async function showHistory() {
      if (!user) {
        showRegisterScreen();
        document.getElementById('auth-message').textContent = 'Please sign up or log in to view reflections.';
        return;
      }
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.remove('hidden');
      document.getElementById('options-menu').style.display = 'none';
      await loadReflections();
      const list = document.getElementById('history-list');
      list.innerHTML = '';
      reflections.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <h3>${item.title}</h3>
          <p>${item.reflection}</p>
          <small>${item.date}</small>
          ${item.image ? `<img src="${item.image}">` : ""}
          <div class="button-group">
            <button class="button" onclick="editReflection(${index})">Edit</button>
            <button class="button" onclick="reviewReflection(${index})">Review</button>
            <button class="button" onclick="deleteReflection(${index})">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function editReflection(index) {
      showEntryScreen(index);
    }

    function reviewReflection(index) {
      alert(`Title: ${reflections[index].title}\n\nReflection: ${reflections[index].reflection}\n\nDate: ${reflections[index].date}`);
    }

    async function deleteReflection(index) {
      if (confirm('Are you sure you want to delete this reflection?')) {
        try {
          const { error } = await supabase
            .from('reflections')
            .delete()
            .eq('id', reflections[index].id);
          if (error) {
            console.error('Error deleting reflection:', error);
            // Continue with local deletion even if database fails
          }
          reflections.splice(index, 1);
          localStorage.setItem('reflections', JSON.stringify(reflections));
          showHistory();
        } catch (err) {
          console.error('Unexpected error deleting reflection:', err);
          // Fallback to local deletion
          reflections.splice(index, 1);
          localStorage.setItem('reflections', JSON.stringify(reflections));
          showHistory();
        }
      }
    }

    function startVoiceRecognition() {
      if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
        alert('Speech recognition is not supported in your browser. Use Chrome.');
        return;
      }
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const chunk = res[0].transcript;
          if (res.isFinal) {
            appendSmartSentence(chunk);
          }
        }
        checkSaveEnabled();
      };
      recognition.onend = () => {
        document.getElementById('start-voice').disabled = false;
        document.getElementById('stop-voice').disabled = true;
      };
      recognition.onerror = () => {
        document.getElementById('start-voice').disabled = false;
        document.getElementById('stop-voice').disabled = true;
      };
      recognition.start();
      document.getElementById('start-voice').disabled = true;
      document.getElementById('stop-voice').disabled = false;
    }

    function stopVoiceRecognition() {
      if (recognition) recognition.stop();
    }

    function appendSmartSentence(text) {
      const box = document.getElementById('reflection');
      let t = (text || '').trim();
      if (!t) return;
      t = t.replace(/\s+/g, ' ');
      t = t.charAt(0).toUpperCase() + t.slice(1);
      if (!/[.!?â€¦]$/.test(t)) {
        t += '.';
      }
      t += ' ';
      const existing = box.value;
      const needsSpace = existing && !/\s$/.test(existing);
      box.value = existing + (needsSpace ? ' ' : '') + t;
      box.selectionStart = box.selectionEnd = box.value.length;
    }

    function checkSaveEnabled() {
      document.getElementById('save').disabled = !canSave();
    }

    function canSave() {
      const title = document.getElementById('title').value.trim();
      const reflection = document.getElementById('reflection').value.trim();
      return !!(title && reflection);
    }

    async function saveReflection() {
      await saveReflections();
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById('preview-image');
          preview.src = e.target.result;
          preview.style.display = 'block';
          currentImage = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    function toggleOptionsMenu() {
      console.log('Toggling options menu');
      const menu = document.getElementById('options-menu');
      if (!menu) {
        console.error('Options menu element not found');
        return;
      }
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    async function handleSignUp() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const authMessage = document.getElementById('auth-message');

      if (!email || !password) {
        authMessage.textContent = 'Please enter both email and password.';
        return;
      }

      if (password.length < 6) {
        authMessage.textContent = 'Password must be at least 6 characters long.';
        return;
      }

      try {
        authMessage.textContent = 'Creating account...';
        console.log('Attempting sign up for:', email);
        
        // Try to sign up without email confirmation
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: window.location.origin,
            data: {
              email_confirmed: true // Try to bypass email confirmation
            }
          }
        });

        console.log('Sign up response:', { data, error });

        if (error) {
          console.error('Sign up error:', error);
          
          // If email confirmation is required, try a different approach
          if (error.message.includes('Email not confirmed') || error.message.includes('confirm')) {
            authMessage.textContent = 'Email confirmation is required. Please check your email or try logging in directly.';
            return;
          }
          
          authMessage.textContent = `Error: ${error.message}`;
          return;
        }

        if (data.user) {
          // Try to sign in immediately
          try {
            const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
              email,
              password
            });
            
            if (loginError) {
              if (loginError.message.includes('Email not confirmed')) {
                authMessage.textContent = 'Account created! Email confirmation required. Try logging in directly or check your email.';
                console.log('User created, email confirmation required');
              } else {
                authMessage.textContent = `Account created but login failed: ${loginError.message}`;
                console.log('Login failed after signup:', loginError);
              }
            } else {
              authMessage.textContent = 'Account created and logged in successfully!';
              user = loginData.user;
              document.getElementById('auth-button').classList.remove('hidden');
              document.getElementById('auth-button').textContent = `Sign Out (${user.email})`;
              await loadReflections();
              goBack();
              console.log('User created and logged in successfully');
            }
          } catch (loginErr) {
            authMessage.textContent = 'Account created! Try logging in directly.';
            console.log('Login attempt failed:', loginErr);
          }
        } else {
          authMessage.textContent = 'Account creation completed. Try logging in directly.';
          console.log('Sign up completed but no user data returned');
        }
      } catch (err) {
        console.error('Unexpected error during sign up:', err);
        authMessage.textContent = 'An unexpected error occurred. Please try again.';
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const loginMessage = document.getElementById('login-message');

      if (!email || !password) {
        loginMessage.textContent = 'Please enter both email and password.';
        return;
      }

      try {
        loginMessage.textContent = 'Logging in...';
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          console.error('Login error:', error);
          
          // If email confirmation is the issue, try a workaround
          if (error.message.includes('Email not confirmed')) {
            loginMessage.textContent = 'Email not confirmed. Trying alternative login method...';
            
            // Try to create a local session for testing
            const localUser = {
              id: 'local_' + Date.now(),
              email: email,
              email_confirmed_at: new Date().toISOString()
            };
            
            // Store in localStorage for local authentication
            localStorage.setItem('localUser', JSON.stringify(localUser));
            localStorage.setItem('localAuth', 'true');
            
            user = localUser;
            document.getElementById('auth-button').classList.remove('hidden');
            document.getElementById('auth-button').textContent = `Sign Out (${user.email})`;
            await loadReflections();
            goBack();
            loginMessage.textContent = 'Logged in with local authentication!';
            return;
          }
          
          loginMessage.textContent = `Error: ${error.message}`;
          return;
        }

        if (data.user) {
          user = data.user;
          document.getElementById('auth-button').classList.remove('hidden');
          document.getElementById('auth-button').textContent = `Sign Out (${user.email})`;
          await loadReflections();
          goBack();
          loginMessage.textContent = 'Login successful!';
        }
      } catch (err) {
        console.error('Unexpected error during login:', err);
        loginMessage.textContent = 'An unexpected error occurred. Please try again.';
      }
    }

    async function resendConfirmation() {
      const email = document.getElementById('email').value.trim();
      const authMessage = document.getElementById('auth-message');
      
      if (!email) {
        authMessage.textContent = 'Please enter your email address first.';
        return;
      }
      
      try {
        authMessage.textContent = 'Sending confirmation email...';
        
        const { error } = await supabase.auth.resend({
          type: 'signup',
          email: email
        });
        
        if (error) {
          console.error('Resend confirmation error:', error);
          authMessage.textContent = `Error: ${error.message}`;
          return;
        }
        
        authMessage.textContent = 'Confirmation email sent! Check your inbox and spam folder.';
      } catch (err) {
        console.error('Unexpected error during resend:', err);
        authMessage.textContent = 'An unexpected error occurred. Please try again.';
      }
    }

    async function handleForgotPassword() {
      const email = document.getElementById('login-email').value.trim();
      const loginMessage = document.getElementById('login-message');
      
      if (!email) {
        loginMessage.textContent = 'Please enter your email address first.';
        return;
      }
      
      try {
        loginMessage.textContent = 'Sending password reset email...';
        
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin
        });
        
        if (error) {
          console.error('Password reset error:', error);
          loginMessage.textContent = `Error: ${error.message}`;
          return;
        }
        
        loginMessage.textContent = 'Password reset email sent! Check your inbox.';
      } catch (err) {
        console.error('Unexpected error during password reset:', err);
        loginMessage.textContent = 'An unexpected error occurred. Please try again.';
      }
    }

    async function testAuthConnection() {
      console.log('Testing auth connection...');
      try {
        const { data, error } = await supabase.auth.getSession();
        console.log('Auth test result:', { data, error });
        
        // Test if we can get auth settings
        const { data: settings } = await supabase.auth.getUser();
        console.log('User settings:', settings);
        
        alert(`Auth test: ${error ? 'Failed - ' + error.message : 'Success - ' + (data.session ? 'Session found' : 'No session')}`);
      } catch (err) {
        console.error('Auth test error:', err);
        alert('Auth test failed: ' + err.message);
      }
    }

    async function handleSignOut() {
      // Check if using local authentication
      const localAuth = localStorage.getItem('localAuth');
      
      if (localAuth === 'true') {
        // Local sign out
        user = null;
        reflections = [];
        localStorage.removeItem('reflections');
        localStorage.removeItem('localUser');
        localStorage.removeItem('localAuth');
        document.getElementById('auth-button').classList.add('hidden');
        showRegisterScreen();
        console.log('Signed out from local authentication');
      } else {
        // Supabase sign out
        const { error } = await supabase.auth.signOut();
        if (error) {
          console.error('Error signing out:', error);
          alert('Failed to sign out.');
          return;
        }
        user = null;
        reflections = [];
        localStorage.removeItem('reflections');
        localStorage.removeItem('localUser');
        localStorage.removeItem('localAuth');
        document.getElementById('auth-button').classList.add('hidden');
        showRegisterScreen();
      }
    }

    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        // Test basic auth connection instead of database table
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('Supabase connection test failed:', error);
          return false;
        }
        console.log('Supabase connection successful');
        return true;
      } catch (err) {
        console.error('Supabase connection error:', err);
        return false;
      }
    }

    // Initialize auth state
    async function initAuth() {
      try {
        // Check for local authentication first
        const localAuth = localStorage.getItem('localAuth');
        const localUser = localStorage.getItem('localUser');
        
        if (localAuth === 'true' && localUser) {
          user = JSON.parse(localUser);
          document.getElementById('auth-button').classList.remove('hidden');
          document.getElementById('auth-button').textContent = `Sign Out (${user.email})`;
          await loadReflections();
          document.getElementById('main-screen').classList.remove('hidden');
          document.getElementById('register-screen').classList.add('hidden');
          document.getElementById('login-screen').classList.add('hidden');
          console.log('Logged in with local authentication');
          return;
        }
        
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('Error getting session:', error);
        }
        
        if (session && session.user) {
          user = session.user;
          document.getElementById('auth-button').classList.remove('hidden');
          document.getElementById('auth-button').textContent = `Sign Out (${user.email})`;
          await loadReflections();
          document.getElementById('main-screen').classList.remove('hidden');
          document.getElementById('register-screen').classList.add('hidden');
          document.getElementById('login-screen').classList.add('hidden');
        } else {
          showRegisterScreen();
        }

        supabase.auth.onAuthStateChange((event, session) => {
          console.log('Auth state changed:', event, session?.user?.email);
          
          if (event === 'SIGNED_IN' && session) {
            user = session.user;
            document.getElementById('auth-button').classList.remove('hidden');
            document.getElementById('auth-button').textContent = `Sign Out (${user.email})`;
            loadReflections();
            goBack();
          } else if (event === 'SIGNED_OUT') {
            user = null;
            reflections = [];
            localStorage.removeItem('reflections');
            localStorage.removeItem('localUser');
            localStorage.removeItem('localAuth');
            document.getElementById('auth-button').classList.add('hidden');
            showRegisterScreen();
          } else if (event === 'TOKEN_REFRESHED' && session) {
            user = session.user;
          }
        });
      } catch (err) {
        console.error('Error initializing auth:', err);
        showRegisterScreen();
      }
    }

    // Event listeners
    document.getElementById('start-voice').addEventListener('click', startVoiceRecognition);
    document.getElementById('stop-voice').addEventListener('click', stopVoiceRecognition);
    document.getElementById('title').addEventListener('input', checkSaveEnabled);
    document.getElementById('reflection').addEventListener('input', checkSaveEnabled);
    document.getElementById('save').addEventListener('click', saveReflection);
    document.getElementById('image-input').addEventListener('change', previewImage);
    document.getElementById('signup-button').addEventListener('click', handleSignUp);
    document.getElementById('login-button').addEventListener('click', handleLogin);
    document.getElementById('auth-button').addEventListener('click', handleSignOut);

    // Load reflections and initialize auth on page load
    async function initializeApp() {
      console.log('Initializing app...');
      
      // Initialize Supabase first
      if (!initializeSupabase()) {
        console.error('Failed to initialize Supabase - app will not work properly');
        alert('Failed to load authentication system. Please refresh the page.');
        return;
      }
      
      const connectionOk = await testSupabaseConnection();
      if (!connectionOk) {
        console.warn('Supabase connection failed - some features may not work');
      }
      await initAuth();
      setInterval(updateDateTime, 1000);
      updateDateTime();
    }
    
    // Wait for DOM and scripts to load
    function startApp() {
      // Give a little time for scripts to load
      setTimeout(() => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
          initializeApp();
        }
      }, 100);
    }
    
    startApp();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }
  </script>
</body>
</html>
