<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0f0f23">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="application-name" content="My Spiritual Journey">
  <meta name="msapplication-TileColor" content="#0f0f23">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Spiritual Journey</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    /* CSS Variables for theming */
    :root {
      /* Dark Theme (default) */
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-tertiary: #16213e;
      --text-primary: #ffffff;
      --text-secondary: #e2e8f0;
      --text-muted: #cbd5e1;
      --accent-primary: #a855f7;
      --accent-secondary: #6366f1;
      --accent-tertiary: #8b5cf6;
      --header-bg: rgba(15, 15, 35, 0.9);
      --border-color: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(15, 15, 35, 0.8);
      --card-bg: rgba(15, 15, 35, 0.8);
      --star-color: #ffffff;
      --button-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --button-hover: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
    }

    /* Sky Theme */
    [data-theme="sky"] {
      --bg-primary: #e0f2fe;
      --bg-secondary: #bae6fd;
      --bg-tertiary: #7dd3fc;
      --text-primary: #0c4a6e;
      --text-secondary: #0369a1;
      --text-muted: #0ea5e9;
      --accent-primary: #0284c7;
      --accent-secondary: #0369a1;
      --accent-tertiary: #0c4a6e;
      --header-bg: rgba(224, 242, 254, 0.9);
      --border-color: rgba(12, 74, 110, 0.2);
      --input-bg: rgba(255, 255, 255, 0.8);
      --card-bg: rgba(255, 255, 255, 0.9);
      --star-color: #fbbf24;
      --button-gradient: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      --button-hover: linear-gradient(135deg, #0369a1 0%, #0c4a6e 100%);
    }

    body {
      font-family: 'Georgia', serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
      color: var(--text-primary);
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      position: relative;
      transition: all 0.3s ease;
    }
    
    /* Animated Stars Background */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .star {
      position: absolute;
      background: var(--star-color);
      border-radius: 50%;
      animation: twinkle 3s infinite;
    }
    
    .star:nth-child(1) { width: 2px; height: 2px; top: 10%; left: 20%; animation-delay: 0s; }
    .star:nth-child(2) { width: 1px; height: 1px; top: 15%; left: 80%; animation-delay: 0.5s; }
    .star:nth-child(3) { width: 3px; height: 3px; top: 25%; left: 40%; animation-delay: 1s; }
    .star:nth-child(4) { width: 1px; height: 1px; top: 35%; left: 70%; animation-delay: 1.5s; }
    .star:nth-child(5) { width: 2px; height: 2px; top: 45%; left: 10%; animation-delay: 2s; }
    .star:nth-child(6) { width: 1px; height: 1px; top: 55%; left: 90%; animation-delay: 2.5s; }
    .star:nth-child(7) { width: 3px; height: 3px; top: 65%; left: 30%; animation-delay: 0.3s; }
    .star:nth-child(8) { width: 2px; height: 2px; top: 75%; left: 60%; animation-delay: 0.8s; }
    .star:nth-child(9) { width: 1px; height: 1px; top: 85%; left: 15%; animation-delay: 1.3s; }
    .star:nth-child(10) { width: 2px; height: 2px; top: 95%; left: 85%; animation-delay: 1.8s; }
    .star:nth-child(11) { width: 1px; height: 1px; top: 5%; left: 50%; animation-delay: 0.7s; }
    .star:nth-child(12) { width: 3px; height: 3px; top: 20%; left: 5%; animation-delay: 1.2s; }
    .star:nth-child(13) { width: 2px; height: 2px; top: 30%; left: 95%; animation-delay: 1.7s; }
    .star:nth-child(14) { width: 1px; height: 1px; top: 50%; left: 25%; animation-delay: 0.2s; }
    .star:nth-child(15) { width: 2px; height: 2px; top: 60%; left: 75%; animation-delay: 0.9s; }
    .star:nth-child(16) { width: 3px; height: 3px; top: 70%; left: 45%; animation-delay: 1.4s; }
    .star:nth-child(17) { width: 1px; height: 1px; top: 80%; left: 35%; animation-delay: 1.9s; }
    .star:nth-child(18) { width: 2px; height: 2px; top: 90%; left: 65%; animation-delay: 0.4s; }
    .star:nth-child(19) { width: 1px; height: 1px; top: 12%; left: 55%; animation-delay: 0.6s; }
    .star:nth-child(20) { width: 3px; height: 3px; top: 22%; left: 85%; animation-delay: 1.1s; }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    /* Moving stars */
    .moving-star {
      position: absolute;
      background: var(--star-color);
      border-radius: 50%;
      animation: moveStar 8s linear infinite;
    }
    
    .moving-star:nth-child(21) { width: 1px; height: 1px; top: 0%; left: 0%; animation-duration: 12s; }
    .moving-star:nth-child(22) { width: 2px; height: 2px; top: 20%; left: 100%; animation-duration: 15s; animation-delay: 2s; }
    .moving-star:nth-child(23) { width: 1px; height: 1px; top: 40%; left: 0%; animation-duration: 10s; animation-delay: 4s; }
    .moving-star:nth-child(24) { width: 3px; height: 3px; top: 60%; left: 100%; animation-duration: 18s; animation-delay: 1s; }
    .moving-star:nth-child(25) { width: 2px; height: 2px; top: 80%; left: 0%; animation-duration: 14s; animation-delay: 3s; }
    
    @keyframes moveStar {
      0% { transform: translateX(-100px) translateY(0px); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateX(calc(100vw + 100px)) translateY(-50px); opacity: 0; }
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      z-index: 10;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
    }
    
    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 80px 15px 20px 15px;
      position: relative;
      z-index: 1;
    }
    .prompt, h2, p {
      margin: 10px 0;
    }
    h2 {
      font-size: 1.6rem;
      font-weight: 400;
      color: var(--accent-primary);
      letter-spacing: 0.5px;
      text-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
    }
    .prompt {
      font-size: 1.1rem;
      font-style: italic;
      color: var(--text-secondary);
    }
    p {
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .button {
      background: var(--button-gradient);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: 'Georgia', serif;
      font-weight: 400;
      letter-spacing: 1px;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3), 0 0 20px rgba(139, 92, 246, 0.2);
      transition: all 0.3s ease-in-out;
    }
    .button:hover {
      background: var(--button-hover);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(99, 102, 241, 0.4), 0 0 30px rgba(139, 92, 246, 0.3);
      transform: translateY(-2px);
    }
    .button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    .loading {
      position: relative;
      pointer-events: none;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .floating-plus {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--button-gradient);
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3), 0 0 20px rgba(139, 92, 246, 0.2);
      transition: all 0.3s ease-in-out;
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .floating-plus:hover {
      background: var(--button-hover);
      color: #ffffff;
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4), 0 0 25px rgba(139, 92, 246, 0.3);
      transform: translateY(-2px) scale(1.03);
    }
    .floating-plus:active {
      transform: translateY(-1px) scale(1.01);
    }
    .hidden { 
      display: none; 
    }
    
    /* Elegant screen transitions */
    .screen-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fade-out {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.2s ease-out;
    }
    
    .fade-in {
      opacity: 1;
      transform: translateY(0);
      transition: all 0.3s ease-out;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
      width: 100vw;
      height: 100vh;
      background-color: var(--bg-primary) !important;
    }
    
    .loading-overlay.active {
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: all !important;
      display: flex !important;
    }
    
    /* Prevent white flash during transitions */
    body.transitioning {
      overflow: hidden;
    }
    
    .screen-container {
      position: relative;
      min-height: 100vh;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .loading-text {
      margin-top: 20px;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 300;
    }
    input[type="text"], input[type="email"], input[type="password"], textarea {
      width: 90%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin: 10px 0;
      font-family: 'Georgia', serif;
      background: var(--input-bg);
      color: var(--text-primary);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 10px rgba(139, 92, 246, 0.1);
    }
    textarea { min-height: 130px; resize: vertical; }
    #history-list { width: 95%; }
    .history-item {
      text-align: left;
      padding: 15px;
      background: var(--card-bg);
      margin: 8px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 15px rgba(139, 92, 246, 0.1);
      cursor: pointer;
      border: 1px solid var(--border-color);
    }
    .history-item img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 10px;
    }
    .history-item button {
      margin: 4px;
      padding: 6px 14px;
      font-size: 0.85rem;
      border-radius: 20px;
      background: var(--button-gradient);
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease-in-out;
    }
    .history-item button:hover {
      background: var(--button-hover);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
      transform: translateY(-1px);
    }
    img.preview {
      max-width: 90%;
      max-height: 300px;
      margin-top: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      object-fit: cover;
    }
    
    .history-item img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      object-fit: cover;
    }
    #current-date {
      font-size: 1.1rem;
      font-weight: 400;
      color: var(--accent-primary);
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    #current-time {
      font-size: 0.9rem;
      font-weight: 300;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 10px 0;
      flex-wrap: wrap;
    }




    @media (max-width: 480px) {
      h2 { font-size: 1.4rem; }
      .prompt { font-size: 1rem; }
      p { font-size: 0.9rem; }
      .button { font-size: 0.85rem; padding: 8px 16px; }
      input[type="text"], input[type="email"], input[type="password"], textarea { width: 92%; padding: 10px; }
      .history-item { padding: 12px; }
      .floating-plus { width: 52px; height: 52px; font-size: 26px; }
      .options-menu { min-width: 170px; padding: 10px; }
      .options-menu button { padding: 10px 14px; font-size: 0.95rem; min-height: 38px; }
      
      /* Mobile header adjustments */
      .header { padding: 10px 16px; }
      
      /* Mobile photo buttons */
      .photo-buttons {
        flex-direction: column;
        gap: 8px;
      }
      
      .photo-buttons label {
        min-width: 100% !important;
        padding: 14px 20px !important;
        font-size: 1.1rem !important;
      }
    }
    .options-menu {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 25px rgba(139, 92, 246, 0.15);
      padding: 12px;
      display: none;
      z-index: 999;
      border: 1px solid var(--border-color);
      min-width: 180px;
    }
    .options-menu button {
      display: block;
      width: 100%;
      margin: 6px 0;
      background: var(--button-gradient);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
      min-height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    .options-menu button:hover {
      background: var(--button-hover);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    .options-menu button:active {
      transform: translateY(0);
    }

    /* Google Sign In Button Styling */
    .google-signin-btn {
      background: #4285f4 !important;
      border: 1px solid #4285f4 !important;
      color: white !important;
      font-weight: 500;
      transition: all 0.3s ease-in-out;
    }

    .google-signin-btn:hover {
      background: #3367d6 !important;
      border-color: #3367d6 !important;
      color: white !important;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
      transform: translateY(-1px);
    }

    .google-signin-btn:active {
      background: #2c5aa0 !important;
      transform: translateY(0);
    }

    .google-signin-btn svg {
      flex-shrink: 0;
    }

    /* Apple Sign In Button Styling */
    .apple-signin-btn {
      background: #000000 !important;
      border: 1px solid #000000 !important;
      color: white !important;
      font-weight: 500;
      transition: all 0.3s ease-in-out;
    }

    .apple-signin-btn:hover {
      background: #333333 !important;
      border-color: #333333 !important;
      color: white !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }

    .apple-signin-btn:active {
      background: #1a1a1a !important;
      transform: translateY(0);
    }

    .apple-signin-btn svg {
      flex-shrink: 0;
    }

    /* Sun for sky theme */
    .sun {
      position: fixed;
      top: 25%;
      right: 8%;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #fbbf24 0%, #f59e0b 100%);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
      z-index: 1;
      animation: sunGlow 4s ease-in-out infinite alternate;
    }

    @keyframes sunGlow {
      0% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
      100% { box-shadow: 0 0 35px rgba(251, 191, 36, 0.6); }
    }






  </style>
</head>
<body>
  <!-- Animated Stars Background -->
  <div class="stars">
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
  </div>
  

  
  <!-- Sun for Sky Theme -->
  <div class="sun" style="display: none;"></div>
  
  <!-- Elegant Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="opacity: 0; visibility: hidden;">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loading-text">Signing in...</div>
    </div>
  </div>
  
  <div class="header">
    <div>
      <button id="theme-toggle" class="button" onclick="toggleTheme()" style="margin-right: 10px; padding: 8px 12px; font-size: 0.8rem;">üåô</button>
      <!-- Authentication removed - automatic sync without signup -->
    </div>
    <div>
      <button id="sign-out-btn" class="button" onclick="handleSignOut()" style="background: var(--accent-secondary); padding: 8px 12px; font-size: 0.8rem; display: none;">Sign Out</button>
    </div>
  </div>
  

  <!-- Authentication Screen -->
  <div id="auth-screen" class="content screen-transition">
    <h2>My Spiritual Journey</h2>
    
    <!-- Firebase Auth Options -->
    <div style="text-align: center; margin-top: 30px;">
      <!-- Google Sign In Button -->
      <button class="button firebase-google-btn" onclick="signInWithGoogle()" style="background: #4285f4; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; padding: 10px 20px; margin: 0 auto; border-radius: 20px; font-weight: 500; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3); transition: all 0.2s ease;">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
      
      <p style="font-size: 0.9rem; color: var(--text-muted); margin: 20px 0;">One-click sign-in with your Google account</p>
      
      
    </div>
    
    <div id="auth-message" class="prompt" style="display: none; margin-top: 15px;"></div>
  </div>

  <!-- Main Screen -->
  <div id="main-screen" class="content hidden screen-transition">
    <div id="welcome-message" class="prompt" style="display: none; margin-bottom: 20px;"></div>
    <div id="quote" class="prompt">The wound is the place where the light enters you. ‚Äì Rumi</div>
    <button class="button" onclick="newQuote()">Inspire Me</button>
    <h2>My Spiritual Journey</h2>
    <p>Tap the plus button to start your journey</p>
  </div>
  <!-- Authentication screens removed - no signup/login required -->
  <!-- Entry Screen -->
  <div id="entry-screen" class="content hidden">
    <h2 id="entry-date"></h2>
    <div id="reflection-question" class="prompt">What moment today felt like a gift from the universe?</div>
    <button class="button" onclick="newQuestion()">New Question</button>
    <input type="text" id="title" placeholder="Title">
    <textarea id="reflection" placeholder="Speak or type your reflections..."></textarea>
    <div>
      <div class="photo-buttons" style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
        <label for="image-input" class="button" style="display: inline-block; cursor: pointer; padding: 12px 20px; font-size: 1rem; border-radius: 8px; transition: all 0.3s ease; flex: 1; min-width: 150px; text-align: center;">
          üì± Photos App
        </label>
        <label for="camera-input" class="button" style="display: inline-block; cursor: pointer; padding: 12px 20px; font-size: 1rem; border-radius: 8px; transition: all 0.3s ease; flex: 1; min-width: 150px; text-align: center; background: var(--accent-secondary);">
          üì∏ Camera
        </label>
      </div>
      <div style="text-align: center; margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);">
        üì± Photos App: iPhone Photos, Samsung Gallery, Google Photos, etc.
      </div>
      <input type="file" 
             accept="image/*" 
             id="image-input" 
             multiple="false"
             style="display: none;"
             webkitdirectory="false"
             directory="false"
             x-moz-errormessage=""
             data-capture="none">
      <input type="file" 
             accept="image/*" 
             id="camera-input" 
             capture="environment" 
             multiple="false"
             style="display: none;"
             webkitdirectory="false"
             directory="false">
      <div id="image-preview-container" style="display: none;">
        <div id="image-loading" style="display: none; text-align: center; padding: 20px; color: var(--text-muted);">
          üì∏ Loading image...
        </div>
        <img id="preview-image" class="preview" src="" alt="Preview">
        <button type="button" class="button" onclick="removeImage()" style="margin-top: 10px;">Remove Photo</button>
      </div>
    </div>
    <div class="button-group">
      <button class="button" id="start-voice">Start Speaking</button>
      <button class="button" id="stop-voice" disabled>Stop Speaking</button>
      <button class="button" id="save" disabled>Save Reflection</button>
      <button class="button" onclick="goBack()">Back</button>
    </div>
  </div>
  <!-- History Screen -->
  <div id="history-screen" class="content hidden">
    <h2>Past Reflections</h2>
    <div id="history-list"></div>
    <div class="button-group">
      <button class="button" onclick="goBack()">Back</button>
    </div>
  </div>
  <div class="floating-plus" onclick="toggleOptionsMenu()">+</div>
        <div id="options-menu" class="options-menu">
          <button onclick="showEntryScreen()">Start Journaling</button>
          <button onclick="showHistory()">Past Reflections</button>
        </div>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCBKWKwZq8XqECABmuPn5vZ3D8O3hz8Ts0",
      authDomain: "spiritual-journey-e3330.firebaseapp.com",
      projectId: "spiritual-journey-e3330",
      storageBucket: "spiritual-journey-e3330.firebasestorage.app",
      messagingSenderId: "443749946566",
      appId: "1:443749946566:web:b19c90120ed09bb128f3c7",
      measurementId: "G-QFCNBZL9G9"
    };

    // Initialize Firebase
    let firebase;
    let auth;
    let db;
    
    function initializeFirebase() {
      try {
        // Initialize Firebase
        firebase = window.firebase;
        firebase.initializeApp(firebaseConfig);
        
        // Initialize Firebase Auth and Firestore
        auth = firebase.auth();
        db = firebase.firestore();
        
        console.log('Firebase initialized successfully');
        return true;
      } catch (error) {
        console.error('Firebase initialization error:', error);
        return false;
      }
    }
    
    function initializeSupabase() {
      if (typeof window.supabase === 'undefined') {
        console.error('Supabase library not loaded');
        return false;
      }
      
      const supabaseUrl = 'https://ccdbajqwlwgduilomlmq.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZGJhanF3bHdnZHVpbG9tbG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTM0ODIsImV4cCI6MjA3MTk4OTQ4Mn0.Aa9mHZOgL1-EZjn1r_AYbharWttMhVV5zL19x0abnvU';
      
      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
          auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: true
          }
        });
        console.log('Supabase client initialized successfully');
        return true;
      } catch (error) {
        console.error('Failed to initialize Supabase client:', error);
        return false;
      }
    }

    let recognition;
    let reflections = [];
    let currentImage = "";
    let editingIndex = null;
    let user = null;
    let currentTheme = 'dark'; // Default theme
    let lastQuoteIndex = -1; // Track last quote to avoid repetition

    const quotes = [
      "The wound is the place where the light enters you. ‚Äì Rumi",
      "We should write because humans are spiritual beings and writing is a powerful form of prayer and meditation. ‚Äì Gloria Anzald√∫a",
      "Fill your paper with the breathings of your heart. ‚Äì William Wordsworth",
      "There is no way to happiness‚Äîhappiness is the way. ‚Äì Thich Nhat Hanh",
      "The present moment is filled with joy and happiness. If you are attentive, you will see it. ‚Äì Thich Nhat Hanh",
      "Breathing in, I calm my body. Breathing out, I smile. Dwelling in the present moment, I know this is a wonderful moment. ‚Äì Thich Nhat Hanh",
      "You do not need to know precisely what is happening, or exactly where it is all going. What you need is to recognize the possibilities and challenges offered by the present moment, and to embrace them with courage, faith, and hope. ‚Äì Thomas Merton",
      "Happiness is not a matter of intensity but of balance, order, rhythm and harmony. ‚Äì Thomas Merton",
      "Compassion is a verb. ‚Äì Thich Nhat Hanh",
      "When another person makes you suffer, it is because he suffers deeply within himself. He does not need punishment; he needs help. ‚Äì Thich Nhat Hanh",
      "Understanding is love‚Äôs other name. If you don‚Äôt understand, you cannot love. ‚Äì Thich Nhat Hanh",
      "Love is our true destiny. We do not find the meaning of life by ourselves alone‚Äîwe find it with another. ‚Äì Thomas Merton",
      "The biggest human temptation is to settle for too little love. ‚Äì Thomas Merton",
      "Our job is to love others without stopping to inquire whether or not they are worthy. ‚Äì Thomas Merton",
      "Sometimes your joy is the source of your smile, but sometimes your smile can be the source of your joy. ‚Äì Thich Nhat Hanh",
      "Walk as if you are kissing the Earth with your feet. ‚Äì Thich Nhat Hanh",
      "Because you are alive, everything is possible. ‚Äì Thich Nhat Hanh",
      "We are not at peace because we have not yet learned to be alone with ourselves. ‚Äì Thomas Merton",
      "Silence is the language of God, all else is poor translation. ‚Äì Thomas Merton",
      "The things we fear most in prayer are the things that can save us. ‚Äì Thomas Merton",
      "In the stillness of your soul, wisdom whispers its truths. ‚Äì Unknown",
      "Every step you take is a dance with the universe‚Äôs rhythm. ‚Äì Unknown",
      "The heart‚Äôs quiet moments hold the seeds of transformation. ‚Äì Unknown",
      "Embrace the shadows, for they guide you to your light. ‚Äì Unknown",
      "Your spirit blooms where gratitude takes root. ‚Äì Unknown"
    ];
    const journalQuestions = [
      "What moment today felt like a gift from the universe?",
      "How did you find peace in a challenging situation?",
      "What inspires your soul to create today?",
      "What is one thing you‚Äôre grateful for right now?",
      "What vision for your future feels most alive?"
    ];

    function getRandomQuestion() {
      return journalQuestions[Math.floor(Math.random() * journalQuestions.length)];
    }

    function newQuote() {
      let randomIndex;
      
      // Ensure we don't show the same quote twice in a row
      do {
        randomIndex = Math.floor(Math.random() * quotes.length);
      } while (randomIndex === lastQuoteIndex && quotes.length > 1);
      
      lastQuoteIndex = randomIndex;
      document.getElementById('quote').textContent = quotes[randomIndex];
    }

    function newQuestion() {
      document.getElementById('reflection-question').textContent = getRandomQuestion();
    }

    function updateDateTime() {
      const now = new Date();
      
      // Format date for header - minimalist format
      const dateOptions = {
        month: 'short', 
        day: 'numeric'
      };
      const formattedDate = now.toLocaleDateString('en-US', dateOptions);
      document.getElementById('current-date').textContent = formattedDate;
      
      // Format time for header - clean format
      const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: true 
      };
      const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
      document.getElementById('current-time').textContent = formattedTime;
      
      // Format date and time for entry screen
      const entryDateElement = document.getElementById('entry-date');
      if (entryDateElement) {
        const entryOptions = {
          weekday: 'long', 
          month: 'long', 
          day: 'numeric',
          year: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit', 
          hour12: true
        };
        entryDateElement.textContent = now.toLocaleString('en-US', entryOptions);
      }
    }

    // Authentication management
    let currentUser = null;

    // Show login form
    function showLoginForm() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('signup-form').style.display = 'none';
      document.getElementById('auth-message').style.display = 'none';
    }

    // Show signup form
    function showSignupForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('signup-form').style.display = 'block';
      document.getElementById('auth-message').style.display = 'none';
    }

    // Show auth screen
    function showAuthScreen() {
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      
      // Hide sign out button in header
      document.getElementById('sign-out-btn').style.display = 'none';
      
      showLoginForm();
    }

    function showMainScreen() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      
      // Show sign out button in header
      document.getElementById('sign-out-btn').style.display = 'block';
    }

    // Handle user signup
    async function handleSignup() {
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value.trim();
      const message = document.getElementById('auth-message');
      
      if (!email || !password) {
        message.textContent = 'Please enter both email and password.';
        message.style.display = 'block';
        return;
      }
      
      if (password.length < 6) {
        message.textContent = 'Password must be at least 6 characters long.';
        message.style.display = 'block';
        return;
      }
      
      try {
        message.textContent = 'Creating account...';
        message.style.display = 'block';
        
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            emailRedirectTo: `${window.location.origin}${window.location.pathname}`
          }
        });
        
        if (error) {
          console.error('Signup error details:', error);
          message.textContent = `Error: ${error.message}`;
          return;
        }
        
        console.log('Signup response:', data);
        
        if (data.user && !data.user.email_confirmed_at) {
          message.textContent = 'Account created! Please check your email (including spam folder) to confirm your account.';
          message.style.color = 'var(--accent-primary)';
          message.style.fontSize = '0.9rem';
        } else {
          message.textContent = 'Account created successfully!';
          message.style.color = 'var(--accent-primary)';
          // Auto-login if email confirmation is not required
          currentUser = data.user;
          showMainScreen();
          await loadReflections();
        }
        
      } catch (err) {
        console.error('Signup error:', err);
        message.textContent = 'An error occurred. Please try again.';
      }
    }

    // Handle user login
    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const message = document.getElementById('auth-message');
      
      if (!email || !password) {
        message.textContent = 'Please enter both email and password.';
        message.style.display = 'block';
        return;
      }
      
      try {
        message.textContent = 'Signing in...';
        message.style.display = 'block';
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (error) {
          message.textContent = `Error: ${error.message}`;
          return;
        }
        
        currentUser = data.user;
        message.textContent = 'Signed in successfully!';
        message.style.color = 'var(--accent-primary)';
        
        // Show main screen and load reflections
        showMainScreen();
        await loadReflections();
        
      } catch (err) {
        console.error('Login error:', err);
        message.textContent = 'An error occurred. Please try again.';
      }
    }

    // Handle forgot password
    async function handleForgotPassword() {
      const email = document.getElementById('login-email').value.trim();
      const message = document.getElementById('auth-message');
      
      if (!email) {
        message.textContent = 'Please enter your email address first.';
        message.style.display = 'block';
        return;
      }
      
      try {
        message.textContent = 'Sending password reset email...';
        message.style.display = 'block';
        
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: `${window.location.origin}${window.location.pathname}`
        });
        
        if (error) {
          message.textContent = `Error: ${error.message}`;
          return;
        }
        
        message.textContent = 'Password reset email sent! Check your inbox.';
        message.style.color = 'var(--accent-primary)';
        
      } catch (err) {
        console.error('Password reset error:', err);
        message.textContent = 'An error occurred. Please try again.';
      }
    }

    // OAuth functions removed - focusing on working authentication methods

    // Simple local storage authentication - no configuration needed

    function showCloudOptions() {
      document.getElementById('cloud-options').style.display = 'block';
    }

    function hideCloudOptions() {
      document.getElementById('cloud-options').style.display = 'none';
    }

    // Elegant transition functions - NO WHITE FLASHES
    function showLoadingOverlay(text = 'Loading...') {
      const overlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      loadingText.textContent = text;
      
      // Immediately show overlay to prevent any white flash
      overlay.style.opacity = '1';
      overlay.style.visibility = 'visible';
      overlay.style.pointerEvents = 'all';
      overlay.style.display = 'flex';
      overlay.style.zIndex = '99999';
      overlay.classList.add('active');
      
      // Prevent body scrolling during transition
      document.body.classList.add('transitioning');
    }
    
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loading-overlay');
      
      // Reset body scrolling
      document.body.classList.remove('transitioning');
      
      // Fade out the overlay slowly to ensure smooth transition
      overlay.style.opacity = '0';
      overlay.style.visibility = 'hidden';
      overlay.style.pointerEvents = 'none';
      
      // Remove active class after fade
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 200);
    }
    
    function instantScreenChange(fromScreen, toScreen, callback) {
      const from = document.getElementById(fromScreen);
      const to = document.getElementById(toScreen);
      
      // Instantly hide current screen and show new screen
      from.classList.add('hidden');
      to.classList.remove('hidden');
      
      // Show/hide sign out button based on screen
      if (toScreen === 'main-screen') {
        document.getElementById('sign-out-btn').style.display = 'block';
      } else if (toScreen === 'auth-screen') {
        document.getElementById('sign-out-btn').style.display = 'none';
      }
      
      // Execute callback if provided
      if (callback) callback();
      
      // Hide loading overlay after a longer delay to ensure everything is ready
      setTimeout(() => {
        hideLoadingOverlay();
      }, 1000); // 1 second delay to ensure no white page
    }

    // Firebase Google Sign-In - SIMPLE APPROACH
    async function signInWithGoogle() {
      const message = document.getElementById('auth-message');
      
      try {
        // Check if Firebase is initialized
        if (!firebase || !auth) {
          message.textContent = 'Firebase not initialized. Please refresh the page and try again.';
          message.style.display = 'block';
          message.style.color = '#ff6b6b';
          console.error('Firebase not initialized:', { firebase: !!firebase, auth: !!auth });
          return;
        }
        
        // Sign in with Google
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        
        // User signed in successfully
        currentUser = {
          id: result.user.uid,
          email: result.user.email,
          name: result.user.displayName,
          photoURL: result.user.photoURL,
          isFirebase: true
        };
        
        // Load reflections in background
        await loadReflections();
        
        // Simple instant screen change - no loading overlay
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        
      } catch (error) {
        console.error('Google sign-in error:', error);
        
        // Provide more specific error messages
        let errorMessage = 'Sign-in error: ';
        if (error.code === 'auth/popup-closed-by-user') {
          errorMessage += 'Sign-in was cancelled. Please try again.';
        } else if (error.code === 'auth/popup-blocked') {
          errorMessage += 'Popup was blocked. Please allow popups and try again.';
        } else if (error.code === 'auth/unauthorized-domain') {
          errorMessage += 'Domain not authorized. Please add localhost to Firebase authorized domains.';
        } else if (error.code === 'auth/operation-not-allowed') {
          errorMessage += 'Google sign-in not enabled. Please enable it in Firebase console.';
        } else {
          errorMessage += error.message;
        }
        
        message.textContent = errorMessage;
        message.style.display = 'block';
        message.style.color = '#ff6b6b';
      }
    }

    function debugFirebase() {
      const debugInfo = `üîç Firebase Debug Info:

Firebase SDK: ${typeof window.firebase !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded'}
Firebase App: ${typeof firebase !== 'undefined' ? '‚úÖ Initialized' : '‚ùå Not initialized'}
Firebase Auth: ${typeof auth !== 'undefined' ? '‚úÖ Available' : '‚ùå Not available'}
Firebase DB: ${typeof db !== 'undefined' ? '‚úÖ Available' : '‚ùå Not available'}

Current URL: ${window.location.href}
User Agent: ${navigator.userAgent}

Console Errors: Check browser console (F12) for detailed errors

Next Steps:
1. If Firebase SDK not loaded: Check internet connection
2. If Firebase not initialized: Refresh the page
3. If Auth not available: Check Firebase config
4. Check browser console for detailed error messages`;
      
      alert(debugInfo);
      console.log('Firebase Debug:', {
        firebaseSDK: typeof window.firebase,
        firebase: typeof firebase,
        auth: typeof auth,
        db: typeof db,
        config: firebaseConfig
      });
    }

    async function debugFirebaseData() {
      if (!currentUser || !currentUser.isFirebase) {
        alert('Please sign in with Google first to debug data.');
        return;
      }

      try {
        console.log('üîç Debugging Firebase Data...');
        console.log('Current User:', currentUser);
        
        // Test Firestore connection
        const testRef = db.collection('reflections');
        const snapshot = await testRef.where('userId', '==', currentUser.id).get();
        
        console.log('Firestore Query Results:', {
          totalDocs: snapshot.size,
          docs: snapshot.docs.map(doc => ({
            id: doc.id,
            data: doc.data()
          }))
        });
        
        // Check localStorage
        const localData = localStorage.getItem('reflections');
        console.log('LocalStorage Data:', localData ? JSON.parse(localData) : 'No local data');
        
        const debugInfo = `üîç Firebase Data Debug:

User ID: ${currentUser.id}
User Email: ${currentUser.email}

Firestore Results:
- Total documents: ${snapshot.size}
- Documents: ${snapshot.docs.map(doc => doc.data().title || 'Untitled').join(', ') || 'None'}

LocalStorage:
- Has local data: ${localData ? 'Yes' : 'No'}
- Local reflections: ${localData ? JSON.parse(localData).length : 0}

Check browser console (F12) for detailed logs.`;
        
        alert(debugInfo);
        
      } catch (error) {
        console.error('Debug error:', error);
        alert(`Debug Error: ${error.message}\n\nCheck browser console for details.`);
      }
    }

    function showFirebaseSetup() {
      const setupGuide = `üî• Firebase Setup Guide:

‚úÖ Step 1: Enable Authentication
1. Go to: https://console.firebase.google.com/project/spiritual-journey-e3330/authentication
2. Click "Get started"
3. Go to "Sign-in method" tab
4. Enable "Google" provider
5. Add authorized domains:
   - localhost (for testing)
   - your-domain.com (when you deploy)

‚úÖ Step 2: Enable Firestore Database
1. Go to: https://console.firebase.google.com/project/spiritual-journey-e3330/firestore
2. Click "Create database"
3. Choose "Start in test mode"
4. Select location (closest to you)

‚úÖ Step 3: Test Your App
1. Refresh this page
2. Click "Continue with Google"
3. Sign in with your Google account
4. Start journaling!

üéâ Your Firebase project is already configured!
Project ID: spiritual-journey-e3330
Auth Domain: spiritual-journey-e3330.firebaseapp.com

Need help? Check the console for any error messages.`;
      
      alert(setupGuide);
    }

    function setupFirebase() {
      alert('üî• Firebase Setup:\n\n1. Go to https://console.firebase.google.com\n2. Create a new project\n3. Enable Authentication\n4. Add your domain\n5. Copy the config and paste it here\n\nFirebase is much easier than Supabase!');
    }

    function setupAuth0() {
      alert('üîê Auth0 Setup:\n\n1. Go to https://auth0.com\n2. Create a free account\n3. Create a new application\n4. Copy the domain and client ID\n5. Add it to your app\n\nAuth0 handles all the email complexity!');
    }

    function setupClerk() {
      alert('‚ú® Clerk Setup:\n\n1. Go to https://clerk.com\n2. Create a free account\n3. Create a new application\n4. Copy the publishable key\n5. Add it to your app\n\nClerk has beautiful pre-built components!');
    }

    function setupSupabase() {
      alert('üêò Supabase Setup:\n\nYou\'re already using Supabase!\n\nTo fix email issues:\n1. Go to Authentication ‚Üí Settings\n2. Turn OFF "Enable email confirmations"\n3. Users can sign in immediately\n\nOr configure SMTP for email sending.');
    }

    function showQuotaInfo() {
      const quotaInfo = `üìä Firebase Quota Information:

üÜì FREE TIER LIMITS:
‚Ä¢ 50,000 reads per day
‚Ä¢ 20,000 writes per day
‚Ä¢ 1GB storage
‚Ä¢ 10GB bandwidth

‚ö†Ô∏è QUOTA EXCEEDED?
Your data is SAFE! It's saved locally and will sync when quota resets.

üí° SOLUTIONS:
1. Wait for daily quota reset (usually midnight UTC)
2. Upgrade to Firebase Blaze plan ($25/month)
3. Continue using app - data syncs automatically when quota resets

‚úÖ YOUR DATA IS PROTECTED:
‚Ä¢ All journals saved locally
‚Ä¢ Automatic sync when quota resets
‚Ä¢ No data loss

Continue journaling - your spiritual journey is safe! üåü`;
      
      alert(quotaInfo);
    }

    // Handle sign out
    async function handleSignOut() {
      try {
        if (currentUser && currentUser.isFirebase && auth) {
          // Firebase sign out - this will clear the session and allow account switching
          await auth.signOut();
        } else if (currentUser && currentUser.isSupabase && supabase) {
          // Supabase sign out
          const { error } = await supabase.auth.signOut();
          if (error) {
            console.error('Sign out error:', error);
          }
        }
        
        // Clear all user data
        currentUser = null;
        reflections = [];
        localStorage.removeItem('reflections');
        
        // Hide sign out button and show auth screen
        document.getElementById('sign-out-btn').style.display = 'none';
        document.getElementById('main-screen').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
        
        console.log('User signed out successfully - ready for account switching');
        
      } catch (err) {
        console.error('Sign out error:', err);
        
        // Force sign out even if there's an error
        currentUser = null;
        reflections = [];
        localStorage.removeItem('reflections');
        document.getElementById('sign-out-btn').style.display = 'none';
        document.getElementById('main-screen').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
      }
    }

    // Migrate existing local data to user account
    async function migrateLocalData() {
      if (!currentUser) {
        console.log('No user logged in for migration');
          return;
        }

      try {
        // Check for existing local reflections
        const localReflections = localStorage.getItem('reflections');
        if (!localReflections) {
          console.log('No local data to migrate');
          return;
        }

        const localData = JSON.parse(localReflections);
        if (localData.length === 0) {
          console.log('No local reflections to migrate');
          return;
        }

        console.log('Migrating', localData.length, 'local reflections to user account');

        // Upload each local reflection to the database
        for (const reflection of localData) {
          const reflectionData = {
            user_id: currentUser.id,
            title: reflection.title,
            reflection: reflection.reflection,
            date: reflection.date,
            image: reflection.image,
            created_at: reflection.created_at || new Date().toISOString()
          };

          const { data, error } = await supabase
            .from('reflections')
            .insert([reflectionData])
            .select();

          if (error) {
            console.error('Error migrating reflection:', error);
        } else {
            console.log('Successfully migrated reflection:', reflection.title);
          }
        }

        // Reload reflections from database
        await loadReflections();
        console.log('Data migration completed');

      } catch (err) {
        console.error('Error during data migration:', err);
      }
    }

    async function loadReflections() {
      if (!currentUser) {
        console.log('No user logged in');
        reflections = [];
        return;
      }
        
      // Handle Firebase mode
      if (currentUser.isFirebase) {
        console.log('Loading reflections for Firebase user:', currentUser.id);
        try {
          const snapshot = await db.collection('reflections')
            .where('userId', '==', currentUser.id)
            .orderBy('createdAt', 'desc')
            .get();
          
          reflections = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          console.log('Loaded', reflections.length, 'reflections from Firebase');
          
          // Also save to localStorage for offline access
          localStorage.setItem('reflections', JSON.stringify(reflections));
          return;
        } catch (error) {
          console.error('Error loading Firebase reflections:', error);
          console.error('Error details:', {
            code: error.code,
            message: error.message,
            userId: currentUser.id
          });
          
          // Handle specific error types
          let errorMessage = '';
          if (error.code === 'resource-exhausted' || error.message.includes('quota')) {
            errorMessage = `üìä Firebase Quota Exceeded\n\nYour free Firebase quota has been reached. This is normal for active users.\n\n‚úÖ Your journals are still saved locally and will sync when quota resets.\n\nüí° Solutions:\n‚Ä¢ Wait for quota to reset (usually daily)\n‚Ä¢ Upgrade to Firebase paid plan\n‚Ä¢ Continue using local storage (your data is safe)`;
          } else if (error.code === 'permission-denied') {
            errorMessage = `üîí Permission Denied\n\nThere's an issue with database permissions.\n\n‚úÖ Your journals are saved locally and will sync when fixed.`;
          } else if (error.code === 'unavailable') {
            errorMessage = `üåê Service Unavailable\n\nFirebase is temporarily unavailable.\n\n‚úÖ Your journals are saved locally and will sync when service returns.`;
          } else {
            errorMessage = `‚ö†Ô∏è Connection Error\n\nError: ${error.message}\n\n‚úÖ Your journals are saved locally and will sync when connection is restored.`;
          }
          
          // Show user-friendly error message
          alert(errorMessage);
          
          // Fallback to localStorage
          const localReflections = localStorage.getItem('reflections');
          if (localReflections) {
            reflections = JSON.parse(localReflections);
            console.log('Using localStorage fallback with', reflections.length, 'reflections');
          } else {
            reflections = [];
            console.log('No local data available');
          }
          return;
        }
      }
        
      // Fallback for non-Firebase users (should not happen in current setup)
      console.log('No Firebase user detected, showing empty reflections');
      reflections = [];
    }

    async function saveReflections() {
      if (!currentUser) {
        console.log('No user logged in');
        alert('Please sign in to save your reflection.');
        return;
      }
      
      // Get form data
      const title = document.getElementById('title').value.trim();
      const reflection = document.getElementById('reflection').value.trim();
      const date = document.getElementById('entry-date').textContent;
      
      // Debug logging
      console.log('üíæ Saving reflection with data:', {
        title: title,
        reflection: reflection,
        hasImage: !!currentImage,
        imageLength: currentImage ? currentImage.length : 0,
        date: date
      });
      
      // Handle Firebase mode
      if (currentUser.isFirebase) {
        console.log('Saving reflection for Firebase user');
        
        const reflectionData = {
          userId: currentUser.id,
          title,
          reflection,
          date,
          image: currentImage || '', // Ensure image is always a string
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
          // Disable save button during save process
          const saveButton = document.getElementById('save');
          saveButton.disabled = true;
          saveButton.textContent = 'Saving...';
          
          if (editingIndex !== null && reflections[editingIndex]) {
            // Update existing reflection
            console.log('üìù Updating existing reflection');
            await db.collection('reflections').doc(reflections[editingIndex].id).update(reflectionData);
            reflections[editingIndex] = { ...reflections[editingIndex], ...reflectionData };
            console.log('‚úÖ Reflection updated successfully');
          } else {
            // Add new reflection
            console.log('üìù Adding new reflection');
            const docRef = await db.collection('reflections').add(reflectionData);
            reflections.unshift({ id: docRef.id, ...reflectionData });
            console.log('‚úÖ Reflection added successfully with ID:', docRef.id);
          }
          
          // Also save to localStorage for offline access
          localStorage.setItem('reflections', JSON.stringify(reflections));
          
          // Clear form and go back
          currentImage = "";
          editingIndex = null;
          
          // Reset save button
          saveButton.disabled = false;
          saveButton.textContent = 'Save Reflection';
          
          goBack();
          return;
        } catch (error) {
          console.error('Error saving to Firebase:', error);
          console.error('Error details:', {
            code: error.code,
            message: error.message,
            userId: currentUser.id,
            reflectionData: reflectionData
          });
          
          // Reset save button
          const saveButton = document.getElementById('save');
          saveButton.disabled = false;
          saveButton.textContent = 'Save Reflection';
          
          // Handle specific error types
          let errorMessage = '';
          if (error.code === 'resource-exhausted' || error.message.includes('quota')) {
            errorMessage = `üìä Firebase Quota Exceeded\n\nYour free Firebase quota has been reached.\n\n‚úÖ Your journal has been saved locally and will sync when quota resets.\n\nüí° Your data is safe! Continue journaling - it will sync later.`;
          } else if (error.code === 'permission-denied') {
            errorMessage = `üîí Permission Denied\n\nThere's an issue with database permissions.\n\n‚úÖ Your journal has been saved locally and will sync when fixed.`;
          } else if (error.code === 'unavailable') {
            errorMessage = `üåê Service Unavailable\n\nFirebase is temporarily unavailable.\n\n‚úÖ Your journal has been saved locally and will sync when service returns.`;
          } else {
            errorMessage = `‚ö†Ô∏è Save Error\n\nError: ${error.message}\n\n‚úÖ Your journal has been saved locally and will sync when connection is restored.`;
          }
          
          // Show user-friendly error message
          alert(errorMessage);
          
          // Fallback to localStorage
          const localData = {
            id: 'firebase_fallback_' + Date.now(),
            ...reflectionData,
            createdAt: new Date().toISOString()
          };
          
          if (editingIndex !== null && reflections[editingIndex]) {
            reflections[editingIndex] = localData;
          } else {
            reflections.unshift(localData);
          }
          
          localStorage.setItem('reflections', JSON.stringify(reflections));
          currentImage = "";
          editingIndex = null;
          goBack();
          return;
        }
      }
      
      // Fallback for non-Firebase users (should not happen in current setup)
      console.log('No Firebase user detected, cannot save reflection');
      alert('Please sign in with Google to save your reflections.');
    }


    function showEntryScreen(index = null) {
      // No authentication required - allow everyone to create reflections
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.remove('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('title').value = '';
      document.getElementById('reflection').value = '';
      document.getElementById('image-input').value = '';
      document.getElementById('image-preview-container').style.display = 'none';
      currentImage = "";
      editingIndex = index;
      if (index !== null && reflections[index]) {
        document.getElementById('title').value = reflections[index].title;
        document.getElementById('reflection').value = reflections[index].reflection;
        if (reflections[index].image) {
          const preview = document.getElementById('preview-image');
          const container = document.getElementById('image-preview-container');
          const loading = document.getElementById('image-loading');
          
          preview.src = reflections[index].image;
          container.style.display = 'block';
          loading.style.display = 'none';
          preview.style.display = 'block';
          currentImage = reflections[index].image;
        }
      }
      // Ensure save button is properly enabled/disabled
      checkSaveEnabled();
      document.getElementById('start-voice').disabled = false;
      document.getElementById('stop-voice').disabled = true;
      newQuestion();
      updateDateTime();
    }

    function goBack(showWelcome = false) {
      if (recognition) recognition.stop();
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('main-screen').classList.remove('hidden');
      editingIndex = null;
      
      // Show welcome message if user just signed up
      if (showWelcome && user) {
        const welcomeMessage = document.getElementById('welcome-message');
        welcomeMessage.textContent = 'Welcome! Your account has been created and you\'re now logged in.';
        welcomeMessage.style.display = 'block';
        
        // Hide welcome message after 5 seconds
        setTimeout(() => {
          welcomeMessage.style.display = 'none';
        }, 5000);
      }
    }

    async function showHistory() {
      // No authentication required - allow everyone to view reflections
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.remove('hidden');
      document.getElementById('options-menu').style.display = 'none';
      await loadReflections();
      refreshHistoryDisplay();
    }

    function editReflection(index) {
      showEntryScreen(index);
    }

    function reviewReflection(index) {
      alert(`Title: ${reflections[index].title}\n\nReflection: ${reflections[index].reflection}\n\nDate: ${reflections[index].date}`);
    }

    function debugReflections() {
      console.log('=== DEBUG REFLECTIONS ===');
      console.log('Reflections array:', reflections);
      console.log('Reflections length:', reflections.length);
      console.log('localStorage reflections:', localStorage.getItem('reflections'));
      alert(`Total reflections: ${reflections.length}\nCheck console for details.`);
    }

    function clearBrowserCache() {
      try {
        // Clear localStorage
        localStorage.clear();
        // Clear sessionStorage
        sessionStorage.clear();
        console.log('Browser cache cleared');
        return true;
      } catch (err) {
        console.error('Error clearing cache:', err);
        return false;
      }
    }

    async function syncReflections() {
      if (!user) {
        alert('Please log in to sync reflections.');
        return;
      }
      
      try {
        console.log('Starting cloud sync...');
        
        // Get local reflections
        const localReflections = localStorage.getItem('reflections');
        const localData = localReflections ? JSON.parse(localReflections) : [];
        console.log('Local reflections:', localData.length);
        
        // Create a unique cloud user ID based on email
        const cloudUserId = 'cloud_' + user.email.replace(/[^a-zA-Z0-9]/g, '_');
        console.log('Cloud user ID:', cloudUserId);
        
        // Get cloud reflections using the cloud user ID
        const { data: dbData, error: dbError } = await supabase
          .from('reflections')
          .select('*')
          .eq('user_id', cloudUserId)
          .order('created_at', { ascending: false });
        
        if (dbError) {
          console.error('Database error:', dbError);
          alert('Connection error. Please check your internet connection.');
          return;
        }
        
        const dbReflections = dbData || [];
        console.log('Cloud reflections:', dbReflections.length);
        
        // Upload local reflections that don't exist in cloud
        let uploadedCount = 0;
        for (const localReflection of localData) {
          const existsInCloud = dbReflections.some(dbReflection => 
            dbReflection.title === localReflection.title && 
            dbReflection.date === localReflection.date &&
            dbReflection.reflection === localReflection.reflection
          );
          
          if (!existsInCloud) {
            console.log('Uploading:', localReflection.title);
            const { error } = await supabase
              .from('reflections')
              .insert([{
                user_id: cloudUserId,
                title: localReflection.title,
                reflection: localReflection.reflection,
                date: localReflection.date,
                image: localReflection.image,
                created_at: localReflection.created_at || new Date().toISOString()
              }]);
            
            if (!error) {
              uploadedCount++;
              console.log('Successfully uploaded:', localReflection.title);
            } else {
              console.error('Failed to upload:', localReflection.title, error);
            }
          }
        }
        
        // Download cloud reflections that don't exist locally
        let downloadedCount = 0;
        for (const dbReflection of dbReflections) {
          const existsLocally = localData.some(localReflection => 
            localReflection.title === dbReflection.title && 
            localReflection.date === dbReflection.date &&
            localReflection.reflection === dbReflection.reflection
          );
          
          if (!existsLocally) {
            console.log('Downloading:', dbReflection.title);
            localData.push(dbReflection);
            downloadedCount++;
          }
        }
        
        // Update local storage and display
        reflections = localData;
        localStorage.setItem('reflections', JSON.stringify(reflections));
        refreshHistoryDisplay();
        
        // Show results
        let message = 'Sync completed!\n';
        if (uploadedCount > 0) {
          message += `üì§ Uploaded ${uploadedCount} reflections\n`;
        }
        if (downloadedCount > 0) {
          message += `üì• Downloaded ${downloadedCount} reflections\n`;
        }
        if (uploadedCount === 0 && downloadedCount === 0) {
          message += '‚ú® All reflections are in sync!';
        }
        
        message += `\n\nüí° To access on other devices:\n1. Open the app on other device\n2. Sign up with email: ${user.email}\n3. Click "üîÑ Sync" to download your journals`;
        
        alert(message);
        console.log('Sync completed successfully');
        
      } catch (err) {
        console.error('Sync error:', err);
        alert('Sync failed. Please try again.');
      }
    }

    function refreshHistoryDisplay() {
      console.log('Refreshing history display with', reflections.length, 'reflections');
      console.log('Reflections array:', reflections);
      const list = document.getElementById('history-list');
      
      if (!list) {
        console.error('History list element not found!');
        return;
      }
      
      list.innerHTML = '';
      
      if (!reflections || reflections.length === 0) {
        list.innerHTML = '<p>No reflections yet. Start journaling to see them here!</p>';
        console.log('No reflections to display');
        return;
      }
      
      reflections.forEach((item, index) => {
        console.log('Creating display for reflection', index, ':', item.title);
        
        // Format the date and time properly
        let displayDate = 'No date';
        if (item.createdAt) {
          // Handle Firebase timestamp
          const date = item.createdAt.toDate ? item.createdAt.toDate() : new Date(item.createdAt);
          displayDate = date.toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        } else if (item.date) {
          // Fallback to the date field
          displayDate = item.date;
        }
        
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <h3>${item.title || 'Untitled'}</h3>
          <p>${item.reflection || 'No content'}</p>
          <small style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px; display: block;">${displayDate}</small>
          ${item.image ? `<img src="${item.image}">` : ""}
          <div class="button-group">
            <button class="button" onclick="editReflection(${index})">Edit</button>
            <button class="button" onclick="reviewReflection(${index})">Review</button>
            <button class="button" onclick="deleteReflection(${index})" onmouseover="console.log('Delete button hovered, index:', ${index})">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });
      
      console.log('History display refreshed with', reflections.length, 'items');
    }

    async function deleteReflection(index) {
      console.log('=== DELETE FUNCTION CALLED ===');
      console.log('Delete function called with index:', index);
      console.log('Index type:', typeof index);
      console.log('Current reflections array length:', reflections ? reflections.length : 'undefined');
      console.log('Current reflections array:', reflections);
      
      // Convert index to number if it's a string
      if (typeof index === 'string') {
        index = parseInt(index, 10);
        console.log('Converted index to number:', index);
      }
      
      // Ensure reflections array is initialized
      if (!reflections) {
        console.error('Reflections array is not initialized');
        try {
          await loadReflections();
          console.log('Reloaded reflections, new length:', reflections.length);
        } catch (loadErr) {
          console.error('Failed to reload reflections:', loadErr);
          alert('Failed to load reflections. Please refresh the page and try again.');
          return;
        }
      }
      
      if (!reflections || reflections.length === 0) {
        console.error('No reflections found');
        alert('No reflections found. Please refresh the page and try again.');
        return;
      }
      
      if (index < 0 || index >= reflections.length) {
        console.error('Invalid index:', index, 'for array length:', reflections.length);
        alert('Invalid reflection index. Please refresh the page and try again.');
        return;
      }
      
      if (!reflections[index]) {
        console.error('Reflection not found at index:', index);
        alert('Reflection not found. Please refresh the page and try again.');
        return;
      }
      
      console.log('About to show confirmation dialog');
      if (confirm('Are you sure you want to delete this reflection?')) {
        console.log('User confirmed deletion');
        try {
          // Always perform local deletion first
          const deletedReflection = reflections.splice(index, 1)[0];
          console.log('Deleted reflection:', deletedReflection);
          console.log('Remaining reflections:', reflections.length);
          
          // Update localStorage immediately
          try {
            localStorage.setItem('reflections', JSON.stringify(reflections));
            console.log('Updated reflections in localStorage');
          } catch (localErr) {
            console.error('Error updating localStorage:', localErr);
            throw new Error('Failed to save changes locally: ' + localErr.message);
          }
          
          // Try database deletion if the reflection has an ID
          if (deletedReflection.id) {
            try {
              console.log('Attempting database deletion for ID:', deletedReflection.id);
              const { error } = await supabase
                .from('reflections')
                .delete()
                .eq('id', deletedReflection.id);
              
              if (error) {
                console.error('Database deletion error:', error);
                // Don't throw here - local deletion was successful
                alert('Reflection deleted locally but there was an issue with the database. It will be removed when you refresh.');
              } else {
                console.log('Database deletion successful');
              }
            } catch (dbErr) {
              console.error('Database operation failed:', dbErr);
              // Don't throw here - local deletion was successful
              alert('Reflection deleted locally but database sync failed. It will be removed when you refresh.');
            }
          } else {
            console.log('No database ID found, local deletion only');
          }
          
          // Refresh the history display without reloading from storage
          try {
            console.log('Calling refreshHistoryDisplay with', reflections.length, 'reflections');
            refreshHistoryDisplay();
            alert('Reflection deleted successfully!');
          } catch (displayErr) {
            console.error('Error refreshing display:', displayErr);
            throw new Error('Failed to refresh display: ' + displayErr.message);
          }
          
        } catch (err) {
          console.error('Unexpected error deleting reflection:', err);
          console.error('Error details:', err.message, err.stack);
          alert(`Error deleting reflection: ${err.message}. Please check the console for details.`);
        }
      }
    }

    // Theme switching functions
    function toggleTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const sun = document.querySelector('.sun');
      
      if (currentTheme === 'dark') {
        // Switch to sky theme
        document.documentElement.setAttribute('data-theme', 'sky');
        currentTheme = 'sky';
        themeToggle.textContent = 'üåô';
        sun.style.display = 'block';
        localStorage.setItem('theme', 'sky');
      } else {
        // Switch to dark theme
        document.documentElement.removeAttribute('data-theme');
        currentTheme = 'dark';
        themeToggle.textContent = '‚òÄÔ∏è';
        sun.style.display = 'none';
        localStorage.setItem('theme', 'dark');
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      const themeToggle = document.getElementById('theme-toggle');
      const sun = document.querySelector('.sun');
      
      if (savedTheme === 'sky') {
        document.documentElement.setAttribute('data-theme', 'sky');
        currentTheme = 'sky';
        themeToggle.textContent = 'üåô';
        sun.style.display = 'block';
      } else {
        document.documentElement.removeAttribute('data-theme');
        currentTheme = 'dark';
        themeToggle.textContent = '‚òÄÔ∏è';
        sun.style.display = 'none';
      }
    }

    function startVoiceRecognition() {
      if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
        alert('Speech recognition is not supported in your browser. Use Chrome.');
        return;
      }
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const chunk = res[0].transcript;
          if (res.isFinal) {
            appendSmartSentence(chunk);
          }
        }
        checkSaveEnabled();
      };
      recognition.onend = () => {
        document.getElementById('start-voice').disabled = false;
        document.getElementById('stop-voice').disabled = true;
      };
      recognition.onerror = () => {
        document.getElementById('start-voice').disabled = false;
        document.getElementById('stop-voice').disabled = true;
      };
      recognition.start();
      document.getElementById('start-voice').disabled = true;
      document.getElementById('stop-voice').disabled = false;
    }

    function stopVoiceRecognition() {
      if (recognition) recognition.stop();
    }

    function appendSmartSentence(text) {
      const box = document.getElementById('reflection');
      let t = (text || '').trim();
      if (!t) return;
      t = t.replace(/\s+/g, ' ');
      t = t.charAt(0).toUpperCase() + t.slice(1);
      if (!/[.!?‚Ä¶]$/.test(t)) {
        t += '.';
      }
      t += ' ';
      const existing = box.value;
      const needsSpace = existing && !/\s$/.test(existing);
      box.value = existing + (needsSpace ? ' ' : '') + t;
      box.selectionStart = box.selectionEnd = box.value.length;
    }

    function checkSaveEnabled() {
      document.getElementById('save').disabled = !canSave();
    }

    function canSave() {
      const title = document.getElementById('title').value.trim();
      const reflection = document.getElementById('reflection').value.trim();
      const hasImage = currentImage && currentImage.trim() !== '';
      
      const canSaveResult = !!(title && (reflection || hasImage));
      
      // Debug logging
      console.log('üîç canSave check:', {
        title: title,
        reflection: reflection,
        hasImage: hasImage,
        currentImageLength: currentImage ? currentImage.length : 0,
        canSave: canSaveResult
      });
      
      // Can save if there's a title and either reflection text OR an image
      return canSaveResult;
    }

    async function saveReflection() {
      await saveReflections();
    }

    function previewImage(event) {
      console.log('üì∑ Photo upload triggered');
      console.log('Event:', event);
      console.log('Files:', event.target.files);
      
      const file = event.target.files[0];
      if (file) {
        console.log('‚úÖ File selected successfully');
        console.log('Selected file:', file.name, 'Type:', file.type, 'Size:', file.size, 'bytes');
        
        // Accept any file type and size - compression will handle large files
        console.log('üìÅ File accepted:', {
          name: file.name,
          type: file.type,
          size: (file.size / 1024 / 1024).toFixed(2) + ' MB'
        });
        
        const reader = new FileReader();
        const container = document.getElementById('image-preview-container');
        const loading = document.getElementById('image-loading');
        const preview = document.getElementById('preview-image');
        
        // Show loading indicator
        container.style.display = 'block';
        loading.style.display = 'block';
        preview.style.display = 'none';
        
        reader.onload = (e) => {
          try {
            // Compress the image before storing
            compressImage(e.target.result, (compressedDataUrl) => {
              // Set the compressed image source
              preview.src = compressedDataUrl;
              currentImage = compressedDataUrl;
              
              // Hide loading and show image
              loading.style.display = 'none';
              preview.style.display = 'block';
              
              // Check if save button should be enabled
              checkSaveEnabled();
              
              // Add a small delay to ensure the image loads
              setTimeout(() => {
                if (preview.complete && preview.naturalHeight !== 0) {
                  console.log('‚úÖ Image preview loaded successfully:', file.name);
                  console.log('üìè Image dimensions:', preview.naturalWidth, 'x', preview.naturalHeight);
                  console.log('üíæ Original size:', (file.size / 1024 / 1024).toFixed(2), 'MB');
                  console.log('üíæ Compressed size:', (compressedDataUrl.length / 1024 / 1024).toFixed(2), 'MB');
                } else {
                  console.log('‚è≥ Image preview loading...');
                }
              }, 100);
            });
          } catch (error) {
            console.error('Error processing image:', error);
            alert('Error processing the file. Please try a different file.\n\nThe app supports any image format and will automatically compress large files.');
            container.style.display = 'none';
          }
        };
        
        reader.onerror = () => {
          alert('Error reading the file. Please try again.\n\nThis might happen if:\n‚Ä¢ The file is corrupted\n‚Ä¢ The file format is not supported\n‚Ä¢ There\'s insufficient memory\n‚Ä¢ The file is too large for your device\n\nTry selecting a different file or a smaller image.');
          console.error('FileReader error:', reader.error);
          container.style.display = 'none';
        };
        
        // Read the file
        reader.readAsDataURL(file);
      } else {
        console.log('‚ùå No file selected');
        alert('No file selected. Please try again.');
      }
    }

    function compressImage(dataUrl, callback) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Calculate new dimensions (max 1200px width/height for better quality)
        let { width, height } = img;
        const maxSize = 1200;
        
        if (width > height) {
          if (width > maxSize) {
            height = (height * maxSize) / width;
            width = maxSize;
          }
        } else {
          if (height > maxSize) {
            width = (width * maxSize) / height;
            height = maxSize;
          }
        }
        
        // Set canvas dimensions
        canvas.width = width;
        canvas.height = height;
        
        // Draw and compress
        ctx.drawImage(img, 0, 0, width, height);
        
        // Try different quality levels to get under 1MB
        let quality = 0.9;
        let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
        
        // If still too large, reduce quality further
        while (compressedDataUrl.length > 1000000 && quality > 0.1) { // 1MB limit
          quality -= 0.1;
          compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        
        // If still too large, reduce dimensions progressively
        if (compressedDataUrl.length > 1000000) {
          let scaleFactor = 0.8;
          while (compressedDataUrl.length > 1000000 && scaleFactor > 0.3) {
            canvas.width = width * scaleFactor;
            canvas.height = height * scaleFactor;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            scaleFactor -= 0.1;
          }
        }
        
        console.log('üîÑ Image compressed:', {
          original: dataUrl.length,
          compressed: compressedDataUrl.length,
          reduction: ((1 - compressedDataUrl.length / dataUrl.length) * 100).toFixed(1) + '%'
        });
        
        callback(compressedDataUrl);
      };
      
      img.onerror = function() {
        console.error('Error loading image for compression');
        callback(dataUrl); // Fallback to original
      };
      
      img.src = dataUrl;
    }

    function removeImage() {
      const container = document.getElementById('image-preview-container');
      const loading = document.getElementById('image-loading');
      const preview = document.getElementById('preview-image');
      const galleryInput = document.getElementById('image-input');
      const cameraInput = document.getElementById('camera-input');
      
      container.style.display = 'none';
      loading.style.display = 'none';
      preview.style.display = 'block';
      preview.src = '';
      galleryInput.value = '';
      cameraInput.value = '';
      currentImage = '';
      console.log('Image removed');
      
      // Check if save button should be enabled
      checkSaveEnabled();
    }

    function toggleOptionsMenu() {
      console.log('Toggling options menu');
      const menu = document.getElementById('options-menu');
      if (!menu) {
        console.error('Options menu element not found');
        return;
      }
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function copyShareLink() {
      let userId = localStorage.getItem('sharedUserId');
      if (!userId) {
        // Generate a new user ID if none exists
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        localStorage.setItem('sharedUserId', userId);
      }
      
      const shareUrl = `${window.location.origin}${window.location.pathname}?user=${userId}`;
      
      // Try to copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('üì± Share link copied! Open this link on your other devices to sync your journals.\n\n' + shareUrl);
        }).catch(() => {
          // Fallback if clipboard fails
          prompt('Copy this link to share with your other devices:', shareUrl);
        });
      } else {
        // Fallback for older browsers
        prompt('Copy this link to share with your other devices:', shareUrl);
      }
    }












    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        // Test basic auth connection instead of database table
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('Supabase connection test failed:', error);
          return false;
        }
        console.log('Supabase connection successful');
        return true;
      } catch (err) {
        console.error('Supabase connection error:', err);
        return false;
      }
    }

    // Test email configuration
    async function testEmailConfig() {
      const message = document.getElementById('auth-message');
      
      try {
        message.textContent = 'Testing email configuration...';
        message.style.display = 'block';
        
        // Test with a dummy email to see if email confirmation is enabled
        const testEmail = 'test@example.com';
        
        const { data, error } = await supabase.auth.signUp({
          email: testEmail,
          password: 'testpassword123',
          options: {
            emailRedirectTo: `${window.location.origin}${window.location.pathname}`
          }
        });
        
        if (error) {
          console.error('Email test error:', error);
          
          let errorMessage = `Email Configuration Test:\n\n`;
          
          if (error.message.includes('email confirmation')) {
            errorMessage += `‚úÖ Email confirmation is ENABLED\n`;
            errorMessage += `‚ùå But emails are not being sent\n\n`;
            errorMessage += `SOLUTION:\n`;
            errorMessage += `1. Go to Supabase Dashboard\n`;
            errorMessage += `2. Authentication ‚Üí Settings\n`;
            errorMessage += `3. Configure SMTP settings\n`;
            errorMessage += `4. Or disable email confirmation temporarily`;
          } else if (error.message.includes('already registered')) {
            errorMessage += `‚úÖ Email system is working\n`;
            errorMessage += `‚úÖ Email confirmation is enabled\n`;
            errorMessage += `The test email already exists (this is good!)`;
          } else {
            errorMessage += `Error: ${error.message}`;
          }
          
          alert(errorMessage);
          return;
        }
        
        if (data.user && !data.user.email_confirmed_at) {
          alert(`‚úÖ Email Configuration Test:\n\nEmail confirmation is ENABLED\nEmails should be sent to: ${testEmail}\n\nCheck your email (including spam folder)`);
        } else {
          alert(`‚úÖ Email Configuration Test:\n\nEmail confirmation is DISABLED\nUsers can sign in immediately without email verification`);
        }
        
      } catch (err) {
        console.error('Email test error:', err);
        alert(`Email Test Error: ${err.message}`);
      }
    }


    // Initialize auth state - Firebase only
    async function initAuth() {
      // This function is no longer needed since we use Firebase auth
      // Firebase auth is handled in initFirebaseAuth()
      console.log('Using Firebase authentication only');
    }

    // Event listeners
    document.getElementById('start-voice').addEventListener('click', startVoiceRecognition);
    document.getElementById('stop-voice').addEventListener('click', stopVoiceRecognition);
    document.getElementById('title').addEventListener('input', checkSaveEnabled);
    document.getElementById('reflection').addEventListener('input', checkSaveEnabled);
    document.getElementById('save').addEventListener('click', saveReflection);
    // Add event listeners for both gallery and camera inputs
    document.getElementById('image-input').addEventListener('change', previewImage);
    document.getElementById('camera-input').addEventListener('change', previewImage);
    
    // Add click listeners for gallery and camera buttons
    document.querySelector('label[for="image-input"]').addEventListener('click', function(e) {
      e.preventDefault(); // Prevent default label behavior
      console.log('üì± Photos App button clicked');
      
      // Ensure the gallery input opens photo library
      const galleryInput = document.getElementById('image-input');
      galleryInput.removeAttribute('capture');
      galleryInput.setAttribute('data-capture', 'none');
      
      // Trigger the file picker
      galleryInput.click();
    });
    
    document.querySelector('label[for="camera-input"]').addEventListener('click', function(e) {
      e.preventDefault(); // Prevent default label behavior
      console.log('üì∏ Camera button clicked');
      
      // Ensure the camera input opens camera
      const cameraInput = document.getElementById('camera-input');
      cameraInput.setAttribute('capture', 'environment');
      
      // Trigger the camera
      cameraInput.click();
    });

    // Load reflections and initialize auth on page load
    async function initializeApp() {
      console.log('Initializing app...');
      
      // Load theme first
      loadTheme();
      
      // Initialize Firebase
      if (initializeFirebase()) {
        console.log('Firebase initialized successfully');
        await initFirebaseAuth();
      } else {
        console.log('Firebase not configured, showing auth screen');
        showAuthScreen();
      }
      
      setInterval(updateDateTime, 1000);
      updateDateTime();
    }
    
    // Initialize Firebase Auth
    async function initFirebaseAuth() {
      try {
        // Check for existing session
        auth.onAuthStateChanged((user) => {
          if (user) {
            // User is signed in
            currentUser = {
              id: user.uid,
              email: user.email,
              name: user.displayName,
              photoURL: user.photoURL,
              isFirebase: true
            };
            console.log('Firebase user signed in:', {
              uid: user.uid,
              email: user.email,
              displayName: user.displayName
            });
            
            // Simple screen change if coming from auth screen
            const authScreen = document.getElementById('auth-screen');
            if (authScreen && !authScreen.classList.contains('hidden')) {
              document.getElementById('auth-screen').classList.add('hidden');
              document.getElementById('main-screen').classList.remove('hidden');
              document.getElementById('sign-out-btn').style.display = 'block';
              loadReflections();
            } else {
              showMainScreen();
              loadReflections();
            }
          } else {
            // User is signed out
            console.log('No Firebase user signed in');
            showAuthScreen();
          }
        });
      } catch (error) {
        console.error('Firebase auth initialization error:', error);
        showAuthScreen();
      }
    }
    
    // Wait for DOM and scripts to load
    function startApp() {
      // Give a little time for scripts to load
      setTimeout(() => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
          initializeApp();
        }
      }, 100);
    }
    
    startApp();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }
  </script>
</body>
</html>
