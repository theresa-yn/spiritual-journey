<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0f0f23">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="application-name" content="My Spiritual Journey">
  <meta name="msapplication-TileColor" content="#0f0f23">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Spiritual Journey</title>
  <!-- Notion SDK -->
  <script src="https://unpkg.com/@notionhq/client@2.2.3/dist/index.umd.js"></script>
  <style>
    /* CSS Variables for theming */
    :root {
      /* Dark Theme (default) */
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-tertiary: #16213e;
      --text-primary: #ffffff;
      --text-secondary: #e2e8f0;
      --text-muted: #cbd5e1;
      --accent-primary: #a855f7;
      --accent-secondary: #6366f1;
      --accent-tertiary: #8b5cf6;
      --header-bg: rgba(15, 15, 35, 0.9);
      --border-color: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(15, 15, 35, 0.8);
      --card-bg: rgba(15, 15, 35, 0.8);
      --star-color: #ffffff;
      --success-color: #10b981;
      --button-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --button-hover: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
    }

    /* Sky Theme */
    [data-theme="sky"] {
      --bg-primary: #e0f2fe;
      --bg-secondary: #bae6fd;
      --bg-tertiary: #7dd3fc;
      --text-primary: #0c4a6e;
      --text-secondary: #0369a1;
      --text-muted: #0ea5e9;
      --accent-primary: #0284c7;
      --accent-secondary: #0369a1;
      --accent-tertiary: #0c4a6e;
      --header-bg: rgba(224, 242, 254, 0.9);
      --border-color: rgba(12, 74, 110, 0.2);
      --input-bg: rgba(255, 255, 255, 0.8);
      --card-bg: rgba(255, 255, 255, 0.9);
      --star-color: #fbbf24;
      --button-gradient: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      --button-hover: linear-gradient(135deg, #0369a1 0%, #0c4a6e 100%);
    }

    body {
      font-family: 'Georgia', serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
      color: var(--text-primary);
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      position: relative;
      transition: all 0.3s ease;
    }
    
    /* Animated Stars Background */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .star {
      position: absolute;
      background: var(--star-color);
      border-radius: 50%;
      animation: twinkle 3s infinite;
    }
    
    .star:nth-child(1) { width: 2px; height: 2px; top: 10%; left: 20%; animation-delay: 0s; }
    .star:nth-child(2) { width: 1px; height: 1px; top: 15%; left: 80%; animation-delay: 0.5s; }
    .star:nth-child(3) { width: 3px; height: 3px; top: 25%; left: 40%; animation-delay: 1s; }
    .star:nth-child(4) { width: 1px; height: 1px; top: 35%; left: 70%; animation-delay: 1.5s; }
    .star:nth-child(5) { width: 2px; height: 2px; top: 45%; left: 10%; animation-delay: 2s; }
    .star:nth-child(6) { width: 1px; height: 1px; top: 55%; left: 90%; animation-delay: 2.5s; }
    .star:nth-child(7) { width: 3px; height: 3px; top: 65%; left: 30%; animation-delay: 0.3s; }
    .star:nth-child(8) { width: 2px; height: 2px; top: 75%; left: 60%; animation-delay: 0.8s; }
    .star:nth-child(9) { width: 1px; height: 1px; top: 85%; left: 15%; animation-delay: 1.3s; }
    .star:nth-child(10) { width: 2px; height: 2px; top: 95%; left: 85%; animation-delay: 1.8s; }
    .star:nth-child(11) { width: 1px; height: 1px; top: 5%; left: 50%; animation-delay: 0.7s; }
    .star:nth-child(12) { width: 3px; height: 3px; top: 20%; left: 5%; animation-delay: 1.2s; }
    .star:nth-child(13) { width: 2px; height: 2px; top: 30%; left: 95%; animation-delay: 1.7s; }
    .star:nth-child(14) { width: 1px; height: 1px; top: 50%; left: 25%; animation-delay: 0.2s; }
    .star:nth-child(15) { width: 2px; height: 2px; top: 60%; left: 75%; animation-delay: 0.9s; }
    .star:nth-child(16) { width: 3px; height: 3px; top: 70%; left: 45%; animation-delay: 1.4s; }
    .star:nth-child(17) { width: 1px; height: 1px; top: 80%; left: 35%; animation-delay: 1.9s; }
    .star:nth-child(18) { width: 2px; height: 2px; top: 90%; left: 65%; animation-delay: 0.4s; }
    .star:nth-child(19) { width: 1px; height: 1px; top: 12%; left: 55%; animation-delay: 0.6s; }
    .star:nth-child(20) { width: 3px; height: 3px; top: 22%; left: 85%; animation-delay: 1.1s; }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    /* Moving stars */
    .moving-star {
      position: absolute;
      background: var(--star-color);
      border-radius: 50%;
      animation: moveStar 8s linear infinite;
    }
    
    .moving-star:nth-child(21) { width: 1px; height: 1px; top: 0%; left: 0%; animation-duration: 12s; }
    .moving-star:nth-child(22) { width: 2px; height: 2px; top: 20%; left: 100%; animation-duration: 15s; animation-delay: 2s; }
    .moving-star:nth-child(23) { width: 1px; height: 1px; top: 40%; left: 0%; animation-duration: 10s; animation-delay: 4s; }
    .moving-star:nth-child(24) { width: 3px; height: 3px; top: 60%; left: 100%; animation-duration: 18s; animation-delay: 1s; }
    .moving-star:nth-child(25) { width: 2px; height: 2px; top: 80%; left: 0%; animation-duration: 14s; animation-delay: 3s; }
    
    @keyframes moveStar {
      0% { transform: translateX(-100px) translateY(0px); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateX(calc(100vw + 100px)) translateY(-50px); opacity: 0; }
    }
    .header {
      display: flex;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      z-index: 10;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
    }
    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 80px 15px 20px 15px;
      position: relative;
      z-index: 1;
    }
    .prompt, h2, p {
      margin: 10px 0;
    }
    h2 {
      font-size: 1.6rem;
      font-weight: 400;
      color: var(--accent-primary);
      letter-spacing: 0.5px;
      text-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
    }
    .prompt {
      font-size: 1.1rem;
      font-style: italic;
      color: var(--text-secondary);
    }
    p {
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .button {
      background: var(--button-gradient);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: 'Georgia', serif;
      font-weight: 400;
      letter-spacing: 1px;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3), 0 0 20px rgba(139, 92, 246, 0.2);
      transition: all 0.3s ease-in-out;
    }
    .button:hover {
      background: var(--button-hover);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(99, 102, 241, 0.4), 0 0 30px rgba(139, 92, 246, 0.3);
      transform: translateY(-2px);
    }
    .button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    .loading {
      position: relative;
      pointer-events: none;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .floating-plus {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--button-gradient);
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3), 0 0 20px rgba(139, 92, 246, 0.2);
      transition: all 0.3s ease-in-out;
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .floating-plus:hover {
      background: var(--button-hover);
      color: #ffffff;
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4), 0 0 25px rgba(139, 92, 246, 0.3);
      transform: translateY(-2px) scale(1.03);
    }
    .floating-plus:active {
      transform: translateY(-1px) scale(1.01);
    }
    .hidden { display: none; }
    input[type="text"], input[type="email"], input[type="password"], textarea {
      width: 90%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin: 10px 0;
      font-family: 'Georgia', serif;
      background: var(--input-bg);
      color: var(--text-primary);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 10px rgba(139, 92, 246, 0.1);
    }
    textarea { min-height: 130px; resize: vertical; }
    #history-list { width: 95%; }
    .history-item {
      text-align: left;
      padding: 15px;
      background: var(--card-bg);
      margin: 8px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 15px rgba(139, 92, 246, 0.1);
      cursor: pointer;
      border: 1px solid var(--border-color);
    }
    .history-item img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 10px;
    }
    .history-item button {
      margin: 4px;
      padding: 6px 14px;
      font-size: 0.85rem;
      border-radius: 20px;
      background: var(--button-gradient);
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease-in-out;
    }
    .history-item button:hover {
      background: var(--button-hover);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
      transform: translateY(-1px);
    }
    img.preview {
      max-width: 90%;
      max-height: 300px;
      margin-top: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      object-fit: cover;
    }
    
    .history-item img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      object-fit: cover;
    }
    #current-date {
      font-size: 1.1rem;
      font-weight: 400;
      color: var(--accent-secondary);
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    #current-time {
      font-size: 0.9rem;
      font-weight: 300;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 10px 0;
      flex-wrap: wrap;
    }




    @media (max-width: 480px) {
      h2 { font-size: 1.4rem; }
      .prompt { font-size: 1rem; }
      p { font-size: 0.9rem; }
      .button { font-size: 0.85rem; padding: 8px 16px; }
      input[type="text"], input[type="email"], input[type="password"], textarea { width: 92%; padding: 10px; }
      .history-item { padding: 12px; }
      .floating-plus { width: 52px; height: 52px; font-size: 26px; }
      .options-menu { min-width: 170px; padding: 10px; }
      .options-menu button { padding: 10px 14px; font-size: 0.95rem; min-height: 38px; }
    }
    .options-menu {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 25px rgba(139, 92, 246, 0.15);
      padding: 12px;
      display: none;
      z-index: 999;
      border: 1px solid var(--border-color);
      min-width: 180px;
    }
    .options-menu button {
      display: block;
      width: 100%;
      margin: 6px 0;
      background: var(--button-gradient);
      color: #ffffff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      min-height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .options-menu button:hover {
      background: var(--button-hover);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .options-menu button:active {
      transform: translateY(0);
    }

    /* Sun for sky theme */
    .sun {
      position: fixed;
      top: 25%;
      right: 8%;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #fbbf24 0%, #f59e0b 100%);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
      z-index: 1;
      animation: sunGlow 4s ease-in-out infinite alternate;
    }

    @keyframes sunGlow {
      0% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
      100% { box-shadow: 0 0 35px rgba(251, 191, 36, 0.6); }
    }






  </style>
</head>
<body>
  <!-- Animated Stars Background -->
  <div class="stars">
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
    <div class="moving-star"></div>
  </div>
  

  
  <!-- Sun for Sky Theme -->
  <div class="sun" style="display: none;"></div>
  
  <div class="header">
    <span id="current-time"></span>
    <div>
      <button id="theme-toggle" class="button" onclick="toggleTheme()" style="margin-right: 10px; padding: 8px 12px; font-size: 0.8rem;">🌙</button>
      <!-- Authentication removed - automatic sync without signup -->
    </div>
  </div>
  

  <!-- Account Setup Screen -->
  <div id="account-screen" class="content">
    <h2>Welcome to Your Spiritual Journey</h2>
    <p>Enter your username to sync your journals across all devices</p>
    
    <div id="account-form">
      <input type="text" id="username" placeholder="Enter your username" maxlength="20">
      <button class="button" onclick="setUsername()">Continue</button>
    </div>
    
    <div id="account-message" class="prompt" style="display: none; margin-top: 15px;"></div>
  </div>

  <!-- Main Screen -->
  <div id="main-screen" class="content hidden">
    <div id="welcome-message" class="prompt" style="display: none; margin-bottom: 20px;"></div>
    <div id="quote" class="prompt">The wound is the place where the light enters you. – Rumi</div>
    <button class="button" onclick="newQuote()">Inspire Me</button>
    <button class="button" onclick="notionLogin()" style="background: #000000; margin-top: 10px;">🔗 Connect to Notion</button>
    <button class="button" onclick="notionSync()" style="background: #10b981; margin-top: 10px;">🔄 Sync with Notion</button>
    <button class="button" onclick="logout()" style="background: var(--accent-color); margin-top: 10px;">Switch Account</button>
    <button class="button" onclick="clearAllData()" style="background: #dc2626; margin-top: 10px;">Clear All Data</button>
          <h2>My Spiritual Journey</h2>
      <p>Tap the plus button to start your journey</p>
      <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">✨ Syncs across all your devices</p>
  </div>
  <!-- Authentication screens removed - no signup/login required -->
  <!-- Entry Screen -->
  <div id="entry-screen" class="content hidden">
    <h2 id="current-date"></h2>
    <div id="reflection-question" class="prompt">What moment today felt like a gift from the universe?</div>
    <button class="button" onclick="newQuestion()">New Question</button>
    <input type="text" id="title" placeholder="Title">
    <textarea id="reflection" placeholder="Speak or type your reflections..."></textarea>
    <div>
      <label for="image-input" class="button" style="display: inline-block; margin: 10px 0; cursor: pointer;">
        📷 Add Photo
      </label>
      <input type="file" accept="image/*" id="image-input" capture="environment" style="display: none;">
      <div id="image-preview-container" style="display: none;">
        <div id="image-loading" style="display: none; text-align: center; padding: 20px; color: var(--text-muted);">
          📸 Loading image...
        </div>
        <img id="preview-image" class="preview" src="" alt="Preview">
        <button type="button" class="button" onclick="removeImage()" style="margin-top: 10px;">Remove Photo</button>
      </div>
    </div>
    <div class="button-group">
      <button class="button" id="start-voice">Start Speaking</button>
      <button class="button" id="stop-voice" disabled>Stop Speaking</button>
      <button class="button" id="save" disabled>Save Reflection</button>
      <button class="button" onclick="goBack()">Back</button>
    </div>
  </div>
  <!-- History Screen -->
  <div id="history-screen" class="content hidden">
    <h2>Past Reflections</h2>
    <div id="history-list"></div>
    <div class="button-group">
      <button class="button" onclick="goBack()">Back</button>
    </div>
  </div>
  <div class="floating-plus" onclick="toggleOptionsMenu()">+</div>
  <div id="options-menu" class="options-menu">
    <button onclick="showEntryScreen()">Start Journaling</button>
    <button onclick="showHistory()">Past Reflections</button>
  </div>
  <script>
    // Notion integration
    let notionClient = null;
    let notionDatabaseId = null;
    
    function initializeNotion() {
      console.log('=== INITIALIZING NOTION ===');
      
      if (typeof window.NotionClient === 'undefined') {
        console.error('Notion SDK not loaded');
        return false;
      }
      
      try {
        // Initialize Notion client (will need user's integration token)
        const integrationToken = localStorage.getItem('notionToken');
        if (integrationToken) {
          notionClient = new window.NotionClient({
            auth: integrationToken
          });
          console.log('Notion client initialized with token');
          return true;
        } else {
          console.log('No Notion token found, user needs to connect');
          return false;
        }
      } catch (error) {
        console.error('Failed to initialize Notion client:', error);
        return false;
      }
    }

    let recognition;
    let reflections = [];
    let currentImage = "";
    let editingIndex = null;
    let user = null;
    let currentTheme = 'dark'; // Default theme

    const quotes = [
      "The wound is the place where the light enters you. – Rumi",
      "We should write because humans are spiritual beings and writing is a powerful form of prayer and meditation. – Gloria Anzaldúa",
      "Fill your paper with the breathings of your heart. – William Wordsworth",
      "There is no way to happiness—happiness is the way. – Thich Nhat Hanh",
      "The present moment is filled with joy and happiness. If you are attentive, you will see it. – Thich Nhat Hanh",
      "Breathing in, I calm my body. Breathing out, I smile. Dwelling in the present moment, I know this is a wonderful moment. – Thich Nhat Hanh",
      "You do not need to know precisely what is happening, or exactly where it is all going. What you need is to recognize the possibilities and challenges offered by the present moment, and to embrace them with courage, faith, and hope. – Thomas Merton",
      "Happiness is not a matter of intensity but of balance, order, rhythm and harmony. – Thomas Merton",
      "Compassion is a verb. – Thich Nhat Hanh",
      "When another person makes you suffer, it is because he suffers deeply within himself. He does not need punishment; he needs help. – Thich Nhat Hanh",
      "Understanding is love’s other name. If you don’t understand, you cannot love. – Thich Nhat Hanh",
      "Love is our true destiny. We do not find the meaning of life by ourselves alone—we find it with another. – Thomas Merton",
      "The biggest human temptation is to settle for too little love. – Thomas Merton",
      "Our job is to love others without stopping to inquire whether or not they are worthy. – Thomas Merton",
      "Sometimes your joy is the source of your smile, but sometimes your smile can be the source of your joy. – Thich Nhat Hanh",
      "Walk as if you are kissing the Earth with your feet. – Thich Nhat Hanh",
      "Because you are alive, everything is possible. – Thich Nhat Hanh",
      "We are not at peace because we have not yet learned to be alone with ourselves. – Thomas Merton",
      "Silence is the language of God, all else is poor translation. – Thomas Merton",
      "The things we fear most in prayer are the things that can save us. – Thomas Merton",
      "In the stillness of your soul, wisdom whispers its truths. – Unknown",
      "Every step you take is a dance with the universe’s rhythm. – Unknown",
      "The heart’s quiet moments hold the seeds of transformation. – Unknown",
      "Embrace the shadows, for they guide you to your light. – Unknown",
      "Your spirit blooms where gratitude takes root. – Unknown"
    ];
    const journalQuestions = [
      "What moment today felt like a gift from the universe?",
      "How did you find peace in a challenging situation?",
      "What inspires your soul to create today?",
      "What is one thing you’re grateful for right now?",
      "What vision for your future feels most alive?"
    ];

    function getRandomQuestion() {
      return journalQuestions[Math.floor(Math.random() * journalQuestions.length)];
    }

    function newQuote() {
      document.getElementById('quote').textContent =
        quotes[Math.floor(Math.random() * quotes.length)];
    }

    function newQuestion() {
      document.getElementById('reflection-question').textContent = getRandomQuestion();
    }

    function updateDateTime() {
      const now = new Date();
      const options = {
        weekday: 'long', month: 'short', day: 'numeric',
        year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
      };
      document.getElementById('current-date').textContent =
        now.toLocaleString('en-US', options).replace(',', '');
      document.getElementById('current-time').textContent =
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) + ' CDT';
    }

    // Simple username system
    let currentUser = null;
    
    // Generate deterministic UUID for database compatibility
    function generateDeterministicUUID(username) {
      // Create a deterministic UUID based on username for cross-device sync
      const input = username.toLowerCase();
      
      // Create a seed from the username
      let seed = 0;
      for (let i = 0; i < input.length; i++) {
        const char = input.charCodeAt(i);
        seed = ((seed << 5) - seed) + char;
        seed = seed & seed;
      }
      
      // Generate deterministic UUID v4 format
      // Format: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
      const positiveSeed = Math.abs(seed);
      
      // Create 32 hex characters from the seed
      const hexString = positiveSeed.toString(16).padStart(8, '0') + 
                       (positiveSeed * 7).toString(16).padStart(8, '0') +
                       (positiveSeed * 13).toString(16).padStart(8, '0') +
                       (positiveSeed * 17).toString(16).padStart(8, '0');
      
      // Format as proper UUID: 8-4-4-4-12
      const uuid = [
        hexString.substring(0, 8),                    // 8 chars
        hexString.substring(8, 12),                   // 4 chars
        '4' + hexString.substring(13, 16),           // 4 chars (version 4)
        ((parseInt(hexString.substring(16, 17), 16) & 0x3) | 0x8).toString(16) + hexString.substring(17, 20), // 4 chars (variant)
        hexString.substring(20, 32)                   // 12 chars
      ].join('-');
      
      console.log('Generated deterministic UUID for', username, ':', uuid);
      return uuid;
    }
    
    // Migrate old user format to new proper UUID format
    function migrateUserToProperUUID(user) {
      if (!user || !user.userId) return user;
      
      // Check if userId is in old format (starts with 'user_' or is numeric)
      if (user.userId.startsWith('user_') || /^\d+$/.test(user.userId)) {
        console.log('Migrating old user format to proper UUID:', user.userId);
        
        // Generate new deterministic UUID based on username
        const newUserId = generateDeterministicUUID(user.username);
        
        // Create new user object with proper UUID
        const migratedUser = {
          username: user.username,
          userId: newUserId
        };
        
        console.log('Migrated user:', migratedUser);
        
        // Save migrated user
        localStorage.setItem('currentUser', JSON.stringify(migratedUser));
        
        // Also migrate any existing reflections data
        const oldKey = 'reflections_' + user.userId;
        const newKey = 'reflections_' + newUserId;
        const oldData = localStorage.getItem(oldKey);
        if (oldData) {
          localStorage.setItem(newKey, oldData);
          localStorage.removeItem(oldKey);
          console.log('Migrated reflections data from', oldKey, 'to', newKey);
        }
        
        return migratedUser;
      }
      
      return user;
    }

    function setUsername() {
      console.log('=== SET USERNAME CALLED ===');
      const username = document.getElementById('username').value.trim();
      const message = document.getElementById('account-message');
      
      console.log('Username entered:', username);
      console.log('Username length:', username.length);
      
      if (!username) {
        console.log('No username entered');
        message.textContent = 'Please enter a username';
        message.style.display = 'block';
        return;
      }
      
      if (username.length < 2) {
        console.log('Username too short');
        message.textContent = 'Username must be at least 2 characters';
        message.style.display = 'block';
        return;
      }
      
      // Generate a deterministic UUID for database compatibility
      const userId = generateDeterministicUUID(username);
      console.log('Generated deterministic UUID:', userId);
      
      currentUser = {
        username: username,
        userId: userId
      };
      
      console.log('Created user object:', currentUser);
      
      // Save to localStorage
      const userJson = JSON.stringify(currentUser);
      console.log('Saving to localStorage:', userJson);
      localStorage.setItem('currentUser', userJson);
      
      // Verify save
      const saved = localStorage.getItem('currentUser');
      console.log('Verified save:', saved);
      
      message.textContent = 'Welcome, ' + username + '!';
      message.style.display = 'block';
      message.style.color = 'var(--success-color)';
      
      // Show main screen immediately
      setTimeout(() => {
        console.log('Switching to main screen');
        showMainScreen();
      }, 1000);
    }

    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      showAccountScreen();
    }

    async function notionLogin() {
      console.log('=== NOTION LOGIN ===');
      
      if (!currentUser) {
        alert('❌ Please set a username first.');
        return;
      }
      
      // Prompt for Notion integration token
      const token = prompt('Enter your Notion Integration Token:\n\n1. Go to https://www.notion.so/my-integrations\n2. Create a new integration\n3. Copy the "Internal Integration Token"\n4. Paste it here:');
      
      if (!token) {
        alert('❌ No token provided. Notion connection cancelled.');
        return;
      }
      
      try {
        // Test the token
        const testClient = new window.NotionClient({ auth: token });
        const response = await testClient.users.me();
        
        // Save token and initialize client
        localStorage.setItem('notionToken', token);
        notionClient = testClient;
        
        // Create or find database
        await createNotionDatabase();
        
        alert('✅ Notion Connected!\n\nUser: ' + response.name + '\nEmail: ' + response.person?.email + '\n\nYour journals will now sync to Notion!');
        
      } catch (error) {
        console.error('Notion login failed:', error);
        alert('❌ Notion Connection Failed\n\nError: ' + error.message + '\n\nPlease check your integration token and try again.');
      }
    }
    
    async function createNotionDatabase() {
      try {
        // Try to find existing database first
        const searchResponse = await notionClient.search({
          query: 'Spiritual Journey',
          filter: {
            property: 'object',
            value: 'database'
          }
        });
        
        if (searchResponse.results.length > 0) {
          notionDatabaseId = searchResponse.results[0].id;
          console.log('Found existing database:', notionDatabaseId);
          return;
        }
        
        // Create new database
        const response = await notionClient.databases.create({
          parent: {
            type: 'page_id',
            page_id: 'YOUR_NOTION_PAGE_ID' // This would need to be configured
          },
          title: [
            {
              type: 'text',
              text: {
                content: 'Spiritual Journey'
              }
            }
          ],
          properties: {
            'Title': {
              title: {}
            },
            'Reflection': {
              rich_text: {}
            },
            'Date': {
              date: {}
            },
            'Username': {
              rich_text: {}
            }
          }
        });
        
        notionDatabaseId = response.id;
        localStorage.setItem('notionDatabaseId', notionDatabaseId);
        console.log('Created new database:', notionDatabaseId);
        
      } catch (error) {
        console.error('Database creation failed:', error);
        throw error;
      }
    }
    
    async function notionSync() {
      console.log('=== NOTION SYNC ===');
      
      if (!currentUser) {
        alert('❌ Please set a username first.');
        return;
      }
      
      if (!notionClient) {
        if (!initializeNotion()) {
          alert('❌ Notion not connected. Please use "Connect to Notion" first.');
          return;
        }
      }
      
      try {
        // Load local reflections
        const userReflectionsKey = 'reflections_' + currentUser.userId;
        const localReflections = localStorage.getItem(userReflectionsKey);
        const reflections = localReflections ? JSON.parse(localReflections) : [];
        
        // Sync to Notion
        let syncedCount = 0;
        for (const reflection of reflections) {
          try {
            await notionClient.pages.create({
              parent: {
                database_id: notionDatabaseId
              },
              properties: {
                'Title': {
                  title: [
                    {
                      text: {
                        content: reflection.title
                      }
                    }
                  ]
                },
                'Reflection': {
                  rich_text: [
                    {
                      text: {
                        content: reflection.reflection
                      }
                    }
                  ]
                },
                'Date': {
                  date: {
                    start: reflection.date
                  }
                },
                'Username': {
                  rich_text: [
                    {
                      text: {
                        content: currentUser.username
                      }
                    }
                  ]
                }
              }
            });
            syncedCount++;
          } catch (error) {
            console.error('Failed to sync reflection:', reflection.title, error);
          }
        }
        
        alert('✅ Notion Sync Complete!\n\nSynced ' + syncedCount + ' reflections to Notion.\n\nYour journals are now available in your Notion workspace!');
        
      } catch (error) {
        console.error('Notion sync failed:', error);
        alert('❌ Notion Sync Failed\n\nError: ' + error.message);
      }
    }

    async function manualSync() {
      console.log('=== MANUAL SYNC ===');
      
      if (!currentUser) {
        alert('❌ No user found. Please set a username first.');
        return;
      }
      
      // Check if supabase is initialized
      if (!supabase) {
        console.log('Supabase not initialized, trying to initialize...');
        if (!initializeSupabase()) {
          alert('❌ Supabase Initialization Failed\n\nCannot connect to database.\nPlease refresh the page and try again.');
          return;
        }
      }
      
      try {
        console.log('Starting manual sync for user:', currentUser.userId);
        
        // Load reflections from database using user_email instead of user_id
        const { data, error } = await supabase
          .from('reflections')
          .select('*')
          .eq('user_email', currentUser.username)
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Database error during sync:', error);
          alert('❌ Sync Failed\n\nDatabase Error: ' + error.message);
          return;
        }
        
        console.log('Loaded from database:', data);
        
        // Update local storage
        const userReflectionsKey = 'reflections_' + currentUser.userId;
        localStorage.setItem(userReflectionsKey, JSON.stringify(data));
        
        // Update reflections array
        reflections = data || [];
        
        // Refresh display
        refreshHistoryDisplay();
        
        alert('✅ Manual Sync Complete!\n\nLoaded ' + (data ? data.length : 0) + ' reflections from database.\n\nUser ID: ' + currentUser.userId);
        
      } catch (err) {
        console.error('Manual sync error:', err);
        alert('❌ Sync Error\n\nError: ' + err.message);
      }
    }

    function forceUUIDUpdate() {
      console.log('=== FORCE UUID UPDATE ===');
      
      if (!currentUser) {
        alert('❌ No user found. Please set a username first.');
        return;
      }
      
      const oldUserId = currentUser.userId;
      const username = currentUser.username;
      
      console.log('Current user ID:', oldUserId);
      console.log('Username:', username);
      
      // Generate new deterministic UUID
      const newUserId = generateDeterministicUUID(username);
      console.log('New deterministic UUID:', newUserId);
      
      // Create new user object
      const newUser = {
        username: username,
        userId: newUserId
      };
      
      // Save new user
      localStorage.setItem('currentUser', JSON.stringify(newUser));
      currentUser = newUser;
      
      // Migrate reflections data if it exists
      const oldKey = 'reflections_' + oldUserId;
      const newKey = 'reflections_' + newUserId;
      const oldData = localStorage.getItem(oldKey);
      
      if (oldData) {
        localStorage.setItem(newKey, oldData);
        localStorage.removeItem(oldKey);
        console.log('Migrated reflections from', oldKey, 'to', newKey);
      }
      
      alert('✅ UUID Updated!\n\nOld ID: ' + oldUserId + '\nNew ID: ' + newUserId + '\n\nYour data has been migrated to the new format.');
      
      console.log('UUID update complete. New user:', currentUser);
    }

    async function shareData() {
      console.log('=== SHARING DATA ===');
      
      if (!currentUser) {
        alert('❌ No user found. Please set a username first.');
        return;
      }
      
      try {
        // Get user's reflections
        const userReflectionsKey = 'reflections_' + currentUser.userId;
        const localReflections = localStorage.getItem(userReflectionsKey);
        const reflections = localReflections ? JSON.parse(localReflections) : [];
        
        // Create share data
        const shareData = {
          username: currentUser.username,
          userId: currentUser.userId,
          reflections: reflections,
          shareDate: new Date().toISOString()
        };
        
        // Encode data as base64
        const dataStr = JSON.stringify(shareData);
        const encodedData = btoa(dataStr);
        
        // Create share URL
        const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
        
        // Try to copy to clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(shareUrl);
          alert('✅ Data Shared!\n\nShare URL copied to clipboard!\n\nSend this URL to your other devices:\n' + shareUrl.substring(0, 100) + '...\n\nOn other devices, use "Load Shared Data" to import.');
        } else {
          // Fallback: show URL in alert
          alert('✅ Data Shared!\n\nShare this URL with your other devices:\n\n' + shareUrl + '\n\nOn other devices, use "Load Shared Data" to import.');
        }
        
      } catch (err) {
        console.error('Share failed:', err);
        alert('❌ Share Failed\n\nError: ' + err.message);
      }
    }

    function loadSharedData() {
      console.log('=== LOADING SHARED DATA ===');
      
      if (!currentUser) {
        alert('❌ No user found. Please set a username first.');
        return;
      }
      
      // Check if there's data in the URL
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('data');
      
      if (encodedData) {
        try {
          // Decode the data
          const dataStr = atob(encodedData);
          const sharedData = JSON.parse(dataStr);
          
          if (!sharedData.reflections || !Array.isArray(sharedData.reflections)) {
            alert('❌ Invalid shared data format.');
            return;
          }
          
          // Merge with existing data
          const userReflectionsKey = 'reflections_' + currentUser.userId;
          const existingReflections = localStorage.getItem(userReflectionsKey);
          const currentReflections = existingReflections ? JSON.parse(existingReflections) : [];
          
          // Merge reflections (avoid duplicates)
          const mergedReflections = [...currentReflections];
          for (const sharedReflection of sharedData.reflections) {
            const exists = mergedReflections.some(existing => 
              existing.title === sharedReflection.title && 
              existing.date === sharedReflection.date &&
              existing.reflection === sharedReflection.reflection
            );
            if (!exists) {
              mergedReflections.push(sharedReflection);
            }
          }
          
          // Save merged data
          localStorage.setItem(userReflectionsKey, JSON.stringify(mergedReflections));
          reflections = mergedReflections;
          
          // Refresh display
          refreshHistoryDisplay();
          
          // Clear URL parameters
          window.history.replaceState({}, document.title, window.location.pathname);
          
          alert('✅ Shared Data Loaded!\n\nImported ' + sharedData.reflections.length + ' reflections.\nTotal reflections: ' + mergedReflections.length);
          
        } catch (err) {
          console.error('Load shared data failed:', err);
          alert('❌ Load Shared Data Failed\n\nError: ' + err.message);
        }
      } else {
        // Prompt for URL
        const shareUrl = prompt('Enter the share URL from another device:');
        if (shareUrl) {
          try {
            const url = new URL(shareUrl);
            const dataParam = url.searchParams.get('data');
            if (dataParam) {
              // Set the data parameter and reload
              window.location.search = '?data=' + dataParam;
            } else {
              alert('❌ Invalid share URL. Please check the URL and try again.');
            }
          } catch (err) {
            alert('❌ Invalid URL format. Please check the URL and try again.');
          }
        }
      }
    }

    function clearAllData() {
      console.log('=== CLEARING ALL DATA ===');
      console.log('Before clear - localStorage keys:', Object.keys(localStorage));
      
      // Clear all localStorage
      localStorage.clear();
      
      console.log('After clear - localStorage keys:', Object.keys(localStorage));
      
      // Reset current user
      currentUser = null;
      
      alert('✅ All data cleared!\n\nLocalStorage has been completely cleared.\nYou can now test with a fresh start.');
      
      // Show account screen
      showAccountScreen();
    }

    function showAccountScreen() {
      document.getElementById('account-screen').classList.remove('hidden');
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
    }

    function showMainScreen() {
      document.getElementById('account-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
    }

    async function loadReflections() {
      // Get current user
      if (!currentUser) {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          currentUser = JSON.parse(savedUser);
        } else {
          console.log('No user logged in');
          return;
        }
      }
      
      const userId = currentUser.userId;
      console.log('Loading reflections for user ID:', userId);
      console.log('Current user object:', currentUser);
      
      try {
        console.log('Loading reflections for user:', userId);
        
        // Always load from user-specific local storage first (guaranteed to work)
        const userReflectionsKey = 'reflections_' + userId;
        const localReflections = localStorage.getItem(userReflectionsKey);
        if (localReflections) {
          reflections = JSON.parse(localReflections);
          console.log('Loaded from user-specific local storage:', reflections.length, 'reflections');
        } else {
          reflections = [];
          console.log('No local reflections found for user:', userId);
        }
        
        // Try to load from cloud database (optional)
        try {
          console.log('Cloud user ID:', userId);
          
          const { data, error } = await supabase
            .from('reflections')
            .select('*')
            .eq('user_email', currentUser.username)
            .order('created_at', { ascending: false });
          
          if (error) {
            console.log('Cloud load failed, using local only:', error.message);
            return;
          }
          
          const dbReflections = data || [];
          console.log('Loaded from cloud:', dbReflections.length, 'reflections');
          
          // Merge cloud and local reflections
          const localData = [...reflections];
          const mergedReflections = [...dbReflections];
          
          // Add local reflections that don't exist in cloud
          localData.forEach(localReflection => {
            const exists = dbReflections.some(dbReflection => 
              dbReflection.id === localReflection.id || 
              (dbReflection.title === localReflection.title && 
               dbReflection.date === localReflection.date &&
               dbReflection.reflection === localReflection.reflection)
            );
            if (!exists) {
              console.log('Adding local reflection to merged list:', localReflection.title);
              mergedReflections.push(localReflection);
            }
          });
          
          // Sort by date (newest first)
          mergedReflections.sort((a, b) => {
            const dateA = new Date(a.created_at || a.date);
            const dateB = new Date(b.created_at || b.date);
            return dateB - dateA;
          });
          
          reflections = mergedReflections;
          const userReflectionsKey = 'reflections_' + userId;
          localStorage.setItem(userReflectionsKey, JSON.stringify(reflections));
          console.log('Merged reflections:', reflections.length, 'total');
          
        } catch (cloudErr) {
          console.log('Cloud sync failed, using local only:', cloudErr.message);
        }
        
      } catch (err) {
        console.error('Unexpected error loading reflections:', err);
        // Fallback to user-specific localStorage
        const userReflectionsKey = 'reflections_' + userId;
        const localReflections = localStorage.getItem(userReflectionsKey);
        if (localReflections) {
          reflections = JSON.parse(localReflections);
        } else {
          reflections = [];
        }
      }
    }

    async function saveReflections() {
      const title = document.getElementById('title').value.trim();
      const reflection = document.getElementById('reflection').value.trim();
      const date = document.getElementById('current-date').textContent;
      
      // Get current user
      if (!currentUser) {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          currentUser = JSON.parse(savedUser);
        } else {
          console.log('No user logged in');
          return;
        }
      }
      
      const userId = currentUser.userId;
      console.log('Saving reflection for user ID:', userId);
      console.log('Current user object:', currentUser);
      
      const reflectionData = {
        user_email: currentUser.username,
        title,
        reflection,
        date,
        image: currentImage,
        created_at: new Date().toISOString()
      };

      // Always save to local storage first (guaranteed to work)
      if (editingIndex !== null && reflections[editingIndex]) {
        // Update existing reflection
        reflections[editingIndex] = { ...reflectionData, id: reflections[editingIndex].id || Date.now() };
      } else {
        // Add new reflection
        const newReflection = { ...reflectionData, id: Date.now() };
        reflections.push(newReflection);
      }
      
      // Save to user-specific local storage immediately
      const userReflectionsKey = 'reflections_' + userId;
      localStorage.setItem(userReflectionsKey, JSON.stringify(reflections));
      console.log('Saved to user-specific local storage:', reflections.length, 'reflections');

      // Try to save to cloud database (optional)
      try {
        if (editingIndex !== null && reflections[editingIndex]) {
          // Update in cloud
          const { error } = await supabase
            .from('reflections')
            .update(reflectionData)
            .eq('id', reflections[editingIndex].id);
          if (error) {
            console.log('Cloud update failed, but local save succeeded:', error.message);
          } else {
            console.log('Successfully updated in cloud');
          }
        } else {
          // Insert in cloud
          const { data, error } = await supabase
            .from('reflections')
            .insert([reflectionData])
            .select();
          if (error) {
            console.log('Cloud insert failed, but local save succeeded:', error.message);
          } else {
            console.log('Successfully saved to cloud');
            // Update local reflection with cloud ID
            if (data && data[0]) {
              reflections[reflections.length - 1].id = data[0].id;
              const userReflectionsKey = 'reflections_' + userId;
              localStorage.setItem(userReflectionsKey, JSON.stringify(reflections));
            }
          }
        }
      } catch (err) {
        console.log('Cloud save failed, but local save succeeded:', err.message);
      }
      
      // Clear form and go back
      currentImage = "";
      editingIndex = null;
      goBack();
    }

    function showRegisterScreen() {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.remove('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('auth-message').textContent = '';
    }

    function showLoginScreen() {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('login-message').textContent = '';
    }

    function showEntryScreen(index = null) {
      // No authentication required - allow everyone to create reflections
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.remove('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('title').value = '';
      document.getElementById('reflection').value = '';
      document.getElementById('image-input').value = '';
      document.getElementById('image-preview-container').style.display = 'none';
      currentImage = "";
      editingIndex = index;
      if (index !== null && reflections[index]) {
        document.getElementById('title').value = reflections[index].title;
        document.getElementById('reflection').value = reflections[index].reflection;
        if (reflections[index].image) {
          const preview = document.getElementById('preview-image');
          const container = document.getElementById('image-preview-container');
          const loading = document.getElementById('image-loading');
          
          preview.src = reflections[index].image;
          container.style.display = 'block';
          loading.style.display = 'none';
          preview.style.display = 'block';
          currentImage = reflections[index].image;
        }
      }
      document.getElementById('save').disabled = !canSave();
      document.getElementById('start-voice').disabled = false;
      document.getElementById('stop-voice').disabled = true;
      newQuestion();
      updateDateTime();
    }

    function goBack(showWelcome = false) {
      if (recognition) recognition.stop();
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      document.getElementById('main-screen').classList.remove('hidden');
      editingIndex = null;
      
      // Show welcome message if user just signed up
      if (showWelcome && user) {
        const welcomeMessage = document.getElementById('welcome-message');
        welcomeMessage.textContent = 'Welcome! Your account has been created and you\'re now logged in.';
        welcomeMessage.style.display = 'block';
        
        // Hide welcome message after 5 seconds
        setTimeout(() => {
          welcomeMessage.style.display = 'none';
        }, 5000);
      }
    }

    async function showHistory() {
      // No authentication required - allow everyone to view reflections
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.remove('hidden');
      document.getElementById('options-menu').style.display = 'none';
      await loadReflections();
      refreshHistoryDisplay();
    }

    function editReflection(index) {
      showEntryScreen(index);
    }

    function reviewReflection(index) {
      alert(`Title: ${reflections[index].title}\n\nReflection: ${reflections[index].reflection}\n\nDate: ${reflections[index].date}`);
    }

    function debugReflections() {
      console.log('=== DEBUG REFLECTIONS ===');
      console.log('Reflections array:', reflections);
      console.log('Reflections length:', reflections.length);
      console.log('localStorage reflections:', localStorage.getItem('reflections'));
      alert(`Total reflections: ${reflections.length}\nCheck console for details.`);
    }

    function clearBrowserCache() {
      try {
        // Clear localStorage
        localStorage.clear();
        // Clear sessionStorage
        sessionStorage.clear();
        console.log('Browser cache cleared');
        return true;
      } catch (err) {
        console.error('Error clearing cache:', err);
        return false;
      }
    }

    async function syncReflections() {
      if (!user) {
        alert('Please log in to sync reflections.');
        return;
      }
      
      try {
        console.log('Starting cloud sync...');
        
        // Get local reflections
        const localReflections = localStorage.getItem('reflections');
        const localData = localReflections ? JSON.parse(localReflections) : [];
        console.log('Local reflections:', localData.length);
        
        // Create a unique cloud user ID based on email
        const cloudUserId = 'cloud_' + user.email.replace(/[^a-zA-Z0-9]/g, '_');
        console.log('Cloud user ID:', cloudUserId);
        
        // Get cloud reflections using the cloud user ID
        const { data: dbData, error: dbError } = await supabase
          .from('reflections')
          .select('*')
          .eq('user_id', cloudUserId)
          .order('created_at', { ascending: false });
        
        if (dbError) {
          console.error('Database error:', dbError);
          alert('Connection error. Please check your internet connection.');
          return;
        }
        
        const dbReflections = dbData || [];
        console.log('Cloud reflections:', dbReflections.length);
        
        // Upload local reflections that don't exist in cloud
        let uploadedCount = 0;
        for (const localReflection of localData) {
          const existsInCloud = dbReflections.some(dbReflection => 
            dbReflection.title === localReflection.title && 
            dbReflection.date === localReflection.date &&
            dbReflection.reflection === localReflection.reflection
          );
          
          if (!existsInCloud) {
            console.log('Uploading:', localReflection.title);
            const { error } = await supabase
              .from('reflections')
              .insert([{
                user_id: cloudUserId,
                title: localReflection.title,
                reflection: localReflection.reflection,
                date: localReflection.date,
                image: localReflection.image,
                created_at: localReflection.created_at || new Date().toISOString()
              }]);
            
            if (!error) {
              uploadedCount++;
              console.log('Successfully uploaded:', localReflection.title);
            } else {
              console.error('Failed to upload:', localReflection.title, error);
            }
          }
        }
        
        // Download cloud reflections that don't exist locally
        let downloadedCount = 0;
        for (const dbReflection of dbReflections) {
          const existsLocally = localData.some(localReflection => 
            localReflection.title === dbReflection.title && 
            localReflection.date === dbReflection.date &&
            localReflection.reflection === dbReflection.reflection
          );
          
          if (!existsLocally) {
            console.log('Downloading:', dbReflection.title);
            localData.push(dbReflection);
            downloadedCount++;
          }
        }
        
        // Update user-specific local storage and display
        reflections = localData;
        const userReflectionsKey = 'reflections_' + userId;
        localStorage.setItem(userReflectionsKey, JSON.stringify(reflections));
        refreshHistoryDisplay();
        
        // Show results
        let message = 'Sync completed!\n';
        if (uploadedCount > 0) {
          message += `📤 Uploaded ${uploadedCount} reflections\n`;
        }
        if (downloadedCount > 0) {
          message += `📥 Downloaded ${downloadedCount} reflections\n`;
        }
        if (uploadedCount === 0 && downloadedCount === 0) {
          message += '✨ All reflections are in sync!';
        }
        
        message += `\n\n💡 To access on other devices:\n1. Open the app on other device\n2. Sign up with email: ${user.email}\n3. Click "🔄 Sync" to download your journals`;
        
        alert(message);
        console.log('Sync completed successfully');
        
      } catch (err) {
        console.error('Sync error:', err);
        alert('Sync failed. Please try again.');
      }
    }

    function refreshHistoryDisplay() {
      console.log('Refreshing history display with', reflections.length, 'reflections');
      console.log('Reflections array:', reflections);
      const list = document.getElementById('history-list');
      
      if (!list) {
        console.error('History list element not found!');
        return;
      }
      
      list.innerHTML = '';
      
      if (!reflections || reflections.length === 0) {
        list.innerHTML = '<p>No reflections yet. Start journaling to see them here!</p>';
        console.log('No reflections to display');
        return;
      }
      
      reflections.forEach((item, index) => {
        console.log('Creating display for reflection', index, ':', item.title);
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <h3>${item.title || 'Untitled'}</h3>
          <p>${item.reflection || 'No content'}</p>
          <small>${item.date || 'No date'}</small>
          ${item.image ? `<img src="${item.image}">` : ""}
          <div class="button-group">
            <button class="button" onclick="editReflection(${index})">Edit</button>
            <button class="button" onclick="reviewReflection(${index})">Review</button>
            <button class="button" onclick="deleteReflection(${index})" onmouseover="console.log('Delete button hovered, index:', ${index})">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });
      
      console.log('History display refreshed with', reflections.length, 'items');
    }

    async function deleteReflection(index) {
      console.log('=== DELETE FUNCTION CALLED ===');
      console.log('Delete function called with index:', index);
      console.log('Index type:', typeof index);
      console.log('Current reflections array length:', reflections ? reflections.length : 'undefined');
      console.log('Current reflections array:', reflections);
      
      // Convert index to number if it's a string
      if (typeof index === 'string') {
        index = parseInt(index, 10);
        console.log('Converted index to number:', index);
      }
      
      // Ensure reflections array is initialized
      if (!reflections) {
        console.error('Reflections array is not initialized');
        try {
          await loadReflections();
          console.log('Reloaded reflections, new length:', reflections.length);
        } catch (loadErr) {
          console.error('Failed to reload reflections:', loadErr);
          alert('Failed to load reflections. Please refresh the page and try again.');
          return;
        }
      }
      
      if (!reflections || reflections.length === 0) {
        console.error('No reflections found');
        alert('No reflections found. Please refresh the page and try again.');
        return;
      }
      
      if (index < 0 || index >= reflections.length) {
        console.error('Invalid index:', index, 'for array length:', reflections.length);
        alert('Invalid reflection index. Please refresh the page and try again.');
        return;
      }
      
      if (!reflections[index]) {
        console.error('Reflection not found at index:', index);
        alert('Reflection not found. Please refresh the page and try again.');
        return;
      }
      
      console.log('About to show confirmation dialog');
      if (confirm('Are you sure you want to delete this reflection?')) {
        console.log('User confirmed deletion');
        try {
          // Always perform local deletion first
          const deletedReflection = reflections.splice(index, 1)[0];
          console.log('Deleted reflection:', deletedReflection);
          console.log('Remaining reflections:', reflections.length);
          
          // Update user-specific localStorage immediately
          try {
            const userReflectionsKey = 'reflections_' + currentUser.userId;
            localStorage.setItem(userReflectionsKey, JSON.stringify(reflections));
            console.log('Updated reflections in user-specific localStorage');
          } catch (localErr) {
            console.error('Error updating localStorage:', localErr);
            throw new Error('Failed to save changes locally: ' + localErr.message);
          }
          
          // Try database deletion if the reflection has an ID
          if (deletedReflection.id) {
            try {
              console.log('Attempting database deletion for ID:', deletedReflection.id);
              const { error } = await supabase
                .from('reflections')
                .delete()
                .eq('id', deletedReflection.id);
              
              if (error) {
                console.error('Database deletion error:', error);
                // Don't throw here - local deletion was successful
                alert('Reflection deleted locally but there was an issue with the database. It will be removed when you refresh.');
              } else {
                console.log('Database deletion successful');
              }
            } catch (dbErr) {
              console.error('Database operation failed:', dbErr);
              // Don't throw here - local deletion was successful
              alert('Reflection deleted locally but database sync failed. It will be removed when you refresh.');
            }
          } else {
            console.log('No database ID found, local deletion only');
          }
          
          // Refresh the history display without reloading from storage
          try {
            console.log('Calling refreshHistoryDisplay with', reflections.length, 'reflections');
            refreshHistoryDisplay();
            alert('Reflection deleted successfully!');
          } catch (displayErr) {
            console.error('Error refreshing display:', displayErr);
            throw new Error('Failed to refresh display: ' + displayErr.message);
          }
          
        } catch (err) {
          console.error('Unexpected error deleting reflection:', err);
          console.error('Error details:', err.message, err.stack);
          alert(`Error deleting reflection: ${err.message}. Please check the console for details.`);
        }
      }
    }

    // Theme switching functions
    function toggleTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const sun = document.querySelector('.sun');
      
      if (currentTheme === 'dark') {
        // Switch to sky theme
        document.documentElement.setAttribute('data-theme', 'sky');
        currentTheme = 'sky';
        themeToggle.textContent = '🌙';
        sun.style.display = 'block';
        localStorage.setItem('theme', 'sky');
      } else {
        // Switch to dark theme
        document.documentElement.removeAttribute('data-theme');
        currentTheme = 'dark';
        themeToggle.textContent = '☀️';
        sun.style.display = 'none';
        localStorage.setItem('theme', 'dark');
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      const themeToggle = document.getElementById('theme-toggle');
      const sun = document.querySelector('.sun');
      
      if (savedTheme === 'sky') {
        document.documentElement.setAttribute('data-theme', 'sky');
        currentTheme = 'sky';
        themeToggle.textContent = '🌙';
        sun.style.display = 'block';
      } else {
        document.documentElement.removeAttribute('data-theme');
        currentTheme = 'dark';
        themeToggle.textContent = '☀️';
        sun.style.display = 'none';
      }
    }

    function startVoiceRecognition() {
      if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
        alert('Speech recognition is not supported in your browser. Use Chrome.');
        return;
      }
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const chunk = res[0].transcript;
          if (res.isFinal) {
            appendSmartSentence(chunk);
          }
        }
        checkSaveEnabled();
      };
      recognition.onend = () => {
        document.getElementById('start-voice').disabled = false;
        document.getElementById('stop-voice').disabled = true;
      };
      recognition.onerror = () => {
        document.getElementById('start-voice').disabled = false;
        document.getElementById('stop-voice').disabled = true;
      };
      recognition.start();
      document.getElementById('start-voice').disabled = true;
      document.getElementById('stop-voice').disabled = false;
    }

    function stopVoiceRecognition() {
      if (recognition) recognition.stop();
    }

    function appendSmartSentence(text) {
      const box = document.getElementById('reflection');
      let t = (text || '').trim();
      if (!t) return;
      t = t.replace(/\s+/g, ' ');
      t = t.charAt(0).toUpperCase() + t.slice(1);
      if (!/[.!?…]$/.test(t)) {
        t += '.';
      }
      t += ' ';
      const existing = box.value;
      const needsSpace = existing && !/\s$/.test(existing);
      box.value = existing + (needsSpace ? ' ' : '') + t;
      box.selectionStart = box.selectionEnd = box.value.length;
    }

    function checkSaveEnabled() {
      document.getElementById('save').disabled = !canSave();
    }

    function canSave() {
      const title = document.getElementById('title').value.trim();
      const reflection = document.getElementById('reflection').value.trim();
      return !!(title && reflection);
    }

    async function saveReflection() {
      await saveReflections();
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image file is too large. Please select an image smaller than 5MB.');
          return;
        }
        
        // Check file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        const reader = new FileReader();
        const container = document.getElementById('image-preview-container');
        const loading = document.getElementById('image-loading');
        const preview = document.getElementById('preview-image');
        
        // Show loading indicator
        container.style.display = 'block';
        loading.style.display = 'block';
        preview.style.display = 'none';
        
        reader.onload = (e) => {
          // Set the image source
          preview.src = e.target.result;
          currentImage = e.target.result;
          
          // Hide loading and show image
          loading.style.display = 'none';
          preview.style.display = 'block';
          
          // Add a small delay to ensure the image loads
          setTimeout(() => {
            if (preview.complete && preview.naturalHeight !== 0) {
              console.log('Image preview loaded successfully:', file.name);
              console.log('Image size:', file.size, 'bytes');
              console.log('Image dimensions:', preview.naturalWidth, 'x', preview.naturalHeight);
            } else {
              console.log('Image preview loading...');
            }
          }, 100);
        };
        
        reader.onerror = () => {
          alert('Error reading the image file. Please try again.');
          console.error('FileReader error:', reader.error);
        };
        
        reader.readAsDataURL(file);
      }
    }

    function removeImage() {
      const container = document.getElementById('image-preview-container');
      const loading = document.getElementById('image-loading');
      const preview = document.getElementById('preview-image');
      const input = document.getElementById('image-input');
      
      container.style.display = 'none';
      loading.style.display = 'none';
      preview.style.display = 'block';
      preview.src = '';
      input.value = '';
      currentImage = '';
      console.log('Image removed');
    }

    function toggleOptionsMenu() {
      console.log('Toggling options menu');
      const menu = document.getElementById('options-menu');
      if (!menu) {
        console.error('Options menu element not found');
        return;
      }
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function copyShareLink() {
      let userId = localStorage.getItem('sharedUserId');
      if (!userId) {
        // Generate a new UUID if none exists
        userId = generateConsistentUUID('shared_' + Date.now());
        localStorage.setItem('sharedUserId', userId);
      }
      
      const shareUrl = `${window.location.origin}${window.location.pathname}?user=${userId}`;
      
      // Try to copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('📱 Share link copied! Open this link on your other devices to sync your journals.\n\n' + shareUrl);
        }).catch(() => {
          // Fallback if clipboard fails
          prompt('Copy this link to share with your other devices:', shareUrl);
        });
      } else {
        // Fallback for older browsers
        prompt('Copy this link to share with your other devices:', shareUrl);
      }
    }

    async function handleSignUp() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const authMessage = document.getElementById('auth-message');

      if (!email || !password) {
        authMessage.textContent = 'Please enter both email and password.';
        return;
      }

      if (password.length < 6) {
        authMessage.textContent = 'Password must be at least 6 characters long.';
        return;
      }

      try {
        const signupButton = document.getElementById('signup-button');
        signupButton.disabled = true;
        signupButton.classList.add('loading');
        signupButton.textContent = 'Creating Account...';
        
        authMessage.textContent = 'Creating cloud account...';
        console.log('Creating cloud account for:', email);
        
        // Create a cloud user account that works immediately
        const cloudUser = {
          id: 'cloud_' + email.replace(/[^a-zA-Z0-9]/g, '_'),
          email: email,
          password: password,
          email_confirmed_at: new Date().toISOString(),
          created_at: new Date().toISOString()
        };
        
        // Store user data locally but mark as cloud user
        localStorage.setItem('cloudUser', JSON.stringify(cloudUser));
        localStorage.setItem('cloudAuth', 'true');
        localStorage.setItem('userPassword', password);
        
        // Set user and log in immediately
        user = cloudUser;
        document.getElementById('auth-button').classList.remove('hidden');
        document.getElementById('auth-button').textContent = 'Sign Out';
        
        // Load any existing reflections from cloud
        await loadReflections();
        
        // Show success message
        goBack(true);
        authMessage.textContent = '✅ Cloud account created! Your journals will sync across all devices.';
        
        // Reset button
        signupButton.disabled = false;
        signupButton.classList.remove('loading');
        signupButton.textContent = 'Create Account (No Email Required)';
        
      } catch (err) {
        console.error('Account creation error:', err);
        authMessage.textContent = 'Error creating account. Please try again.';
        
        // Reset button
        signupButton.disabled = false;
        signupButton.classList.remove('loading');
        signupButton.textContent = 'Create Account (No Email Required)';
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const loginMessage = document.getElementById('login-message');

      if (!email || !password) {
        loginMessage.textContent = 'Please enter both email and password.';
        return;
      }

      try {
        loginMessage.textContent = 'Logging in...';
        
        // First try cloud authentication
        const cloudUser = localStorage.getItem('cloudUser');
        const cloudPassword = localStorage.getItem('cloudPassword');
        
        if (cloudUser && cloudPassword) {
          const userData = JSON.parse(cloudUser);
          if (userData.email === email && cloudPassword === password) {
            // Cloud login successful
            user = userData;
            document.getElementById('auth-button').classList.remove('hidden');
            document.getElementById('auth-button').textContent = 'Sign Out';
            await loadReflections();
            goBack(true);
            loginMessage.textContent = '✅ Login successful! Your journals are synced to the cloud.';
            console.log('Logged in with cloud authentication');
            return;
          }
        }
        
        // Check for existing local user and migrate to cloud
        const localUser = localStorage.getItem('localUser');
        const localPassword = localStorage.getItem('userPassword');
        
        if (localUser && localPassword) {
          const userData = JSON.parse(localUser);
          if (userData.email === email && localPassword === password) {
            // Migrate local user to cloud user
            console.log('Migrating local user to cloud user');
            localStorage.setItem('cloudUser', JSON.stringify(userData));
            localStorage.setItem('cloudAuth', 'true');
            localStorage.setItem('cloudPassword', password);
            
            // Clean up old local data
            localStorage.removeItem('localUser');
            localStorage.removeItem('localAuth');
            localStorage.removeItem('userPassword');
            
            // Login with migrated cloud user
            user = userData;
            document.getElementById('auth-button').classList.remove('hidden');
            document.getElementById('auth-button').textContent = 'Sign Out';
            await loadReflections();
            goBack(true);
            loginMessage.textContent = '✅ Login successful! Your account has been migrated to cloud sync.';
            console.log('Successfully migrated and logged in with cloud authentication');
            return;
          }
        }
        
        loginMessage.textContent = 'Account not found. Please sign up first.';
        
      } catch (err) {
        console.error('Unexpected error during login:', err);
        loginMessage.textContent = 'An unexpected error occurred. Please try again.';
      }
    }

    async function resendConfirmation() {
      const email = document.getElementById('email').value.trim();
      const authMessage = document.getElementById('auth-message');
      
      if (!email) {
        authMessage.textContent = 'Please enter your email address first.';
        return;
      }
      
      // Check if user already has a local account
      const localUser = localStorage.getItem('localUser');
      if (localUser) {
        const userData = JSON.parse(localUser);
        if (userData.email === email) {
          authMessage.textContent = 'You already have a local account! Try logging in instead.';
          return;
        }
      }
      
      try {
        authMessage.textContent = 'Sending confirmation email...';
        
        const { error } = await supabase.auth.resend({
          type: 'signup',
          email: email
        });
        
        if (error) {
          console.error('Resend confirmation error:', error);
          authMessage.textContent = `Error: ${error.message}. Try signing up to create a local account instead.`;
          return;
        }
        
        authMessage.textContent = 'Confirmation email sent! Check your inbox and spam folder.';
      } catch (err) {
        console.error('Unexpected error during resend:', err);
        authMessage.textContent = 'An unexpected error occurred. Try signing up to create a local account instead.';
      }
    }

    // Google Email Authentication
    async function signUpWithGoogle() {
      const authMessage = document.getElementById('auth-message');
      
      try {
        authMessage.textContent = 'Opening Google authentication...';
        
        // Simple Google email input (since we can't use OAuth without backend)
        const googleEmail = prompt('Enter your email address:');
        if (!googleEmail) {
          authMessage.textContent = 'Email sign up cancelled.';
          return;
        }
        
        // Basic email validation
        if (!googleEmail.includes('@') || !googleEmail.includes('.')) {
          authMessage.textContent = 'Please enter a valid email address.';
          return;
        }
        
        // Check if email already exists
        const existingUser = localStorage.getItem('cloudUser');
        if (existingUser) {
          const userData = JSON.parse(existingUser);
          if (userData.email === googleEmail) {
            authMessage.textContent = 'This email is already registered. Please log in instead.';
            return;
          }
        }
        
        // Generate unique verification token
        const verificationToken = Math.random().toString(36).substring(2) + Date.now().toString(36);
        
        // Store pending verification data
        const pendingUser = {
          email: googleEmail,
          name: googleEmail.split('@')[0],
          provider: 'email',
          verificationToken: verificationToken,
          verified: false,
          created_at: new Date().toISOString()
        };
        
        localStorage.setItem('pendingUser', JSON.stringify(pendingUser));
        
        // Show verification screen
        showVerificationScreen(googleEmail, verificationToken);
        
        // Show confirmation link
        const confirmationLink = `${window.location.origin}${window.location.pathname}?verify=${verificationToken}`;
        console.log('Confirmation link for', googleEmail, ':', confirmationLink);
        
        // Show the confirmation link
        showConfirmationLink(googleEmail, confirmationLink);
        authMessage.textContent = '📧 Confirmation link generated! Check the popup for the link.';
        
      } catch (err) {
        console.error('Email sign up error:', err);
        authMessage.textContent = 'Error creating email account. Please try again.';
      }
    }

    async function loginWithGoogle() {
      const loginMessage = document.getElementById('login-message');
      
      try {
        loginMessage.textContent = 'Opening Google authentication...';
        
        // Simple Google email input
        const googleEmail = prompt('Enter your Google email address:');
        if (!googleEmail) {
          loginMessage.textContent = 'Google login cancelled.';
          return;
        }
        
        // Check if user exists
        const cloudUser = localStorage.getItem('cloudUser');
        if (cloudUser) {
          const userData = JSON.parse(cloudUser);
          if (userData.email === googleEmail && userData.provider === 'google') {
            // Google login successful
            user = userData;
            document.getElementById('auth-button').classList.remove('hidden');
            document.getElementById('auth-button').textContent = 'Sign Out';
            await loadReflections();
            goBack(true);
            loginMessage.textContent = '✅ Google login successful!';
            console.log('Logged in with Google email:', googleEmail);
            return;
          }
        }
        
        loginMessage.textContent = 'Google account not found. Please sign up first.';
        
      } catch (err) {
        console.error('Google login error:', err);
        loginMessage.textContent = 'Error logging in with Google. Please try again.';
      }
    }

    // Simple Email Confirmation Function
    function showConfirmationLink(email, confirmationLink) {
      alert(`📧 Confirmation Link\n\nTo: ${email}\n\nClick this link to verify your email:\n${confirmationLink}\n\nCopy and paste this link in your browser to complete verification.`);
    }

    // Email Verification Functions
    function showVerificationScreen(email, verificationToken) {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('verification-screen').classList.remove('hidden');
      document.getElementById('entry-screen').classList.add('hidden');
      document.getElementById('history-screen').classList.add('hidden');
      document.getElementById('options-menu').style.display = 'none';
      
      document.getElementById('verification-email').textContent = email;
      document.getElementById('verification-message').textContent = '';
      
      // Set the confirmation link
      const confirmationLink = `${window.location.origin}${window.location.pathname}?verify=${verificationToken}`;
      const linkElement = document.getElementById('confirmation-link');
      linkElement.href = confirmationLink;
      linkElement.textContent = confirmationLink;
    }

    function goBackToRegister() {
      document.getElementById('verification-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.remove('hidden');
      localStorage.removeItem('pendingUser');
    }

    async function checkEmailVerification() {
      const verificationMessage = document.getElementById('verification-message');
      
      try {
        // Get pending user data
        const pendingUserData = localStorage.getItem('pendingUser');
        if (!pendingUserData) {
          verificationMessage.textContent = 'No pending verification found. Please sign up again.';
          return;
        }
        
        const pendingUser = JSON.parse(pendingUserData);
        
        // Check if user has been verified (this would be set when they click the link)
        if (pendingUser.verified) {
          // Create verified cloud user
          const cloudUser = {
            email: pendingUser.email,
            name: pendingUser.name,
            provider: pendingUser.provider,
            verified: true,
            created_at: pendingUser.created_at,
            verified_at: new Date().toISOString()
          };
          
          // Save to cloud storage
          localStorage.setItem('cloudUser', JSON.stringify(cloudUser));
          localStorage.setItem('cloudAuth', 'true');
          localStorage.setItem('cloudPassword', 'verified_auth');
          
          // Clean up pending data
          localStorage.removeItem('pendingUser');
          
          // Set user and log in
          user = cloudUser;
          document.getElementById('auth-button').classList.remove('hidden');
          document.getElementById('auth-button').textContent = 'Sign Out';
          await loadReflections();
          goBack(true);
          
          verificationMessage.textContent = '✅ Email verified successfully! Account created.';
          console.log('Email verified and account created for:', pendingUser.email);
        } else {
          verificationMessage.textContent = 'Please click the confirmation link in your email first.';
        }
        
      } catch (err) {
        console.error('Email verification error:', err);
        verificationMessage.textContent = 'Error verifying email. Please try again.';
      }
    }

    async function resendVerificationLink() {
      const verificationMessage = document.getElementById('verification-message');
      
      try {
        // Get pending user data
        const pendingUserData = localStorage.getItem('pendingUser');
        if (!pendingUserData) {
          verificationMessage.textContent = 'No pending verification found. Please sign up again.';
          return;
        }
        
        const pendingUser = JSON.parse(pendingUserData);
        
        // Generate new verification token
        const newVerificationToken = Math.random().toString(36).substring(2) + Date.now().toString(36);
        
        // Update pending user with new token
        pendingUser.verificationToken = newVerificationToken;
        localStorage.setItem('pendingUser', JSON.stringify(pendingUser));
        
        // Update the confirmation link on screen
        const confirmationLink = `${window.location.origin}${window.location.pathname}?verify=${newVerificationToken}`;
        const linkElement = document.getElementById('confirmation-link');
        linkElement.href = confirmationLink;
        linkElement.textContent = confirmationLink;
        
        // Show confirmation link
        console.log('New confirmation link for', pendingUser.email, ':', confirmationLink);
        
        // Show the new confirmation link
        showConfirmationLink(pendingUser.email, confirmationLink);
        verificationMessage.textContent = '📧 New confirmation link generated! Check the popup for the link.';
        
      } catch (err) {
        console.error('Resend verification error:', err);
        verificationMessage.textContent = 'Error resending confirmation link. Please try again.';
      }
    }

    async function handleForgotPassword() {
      const email = document.getElementById('login-email').value.trim();
      const loginMessage = document.getElementById('login-message');
      
      if (!email) {
        loginMessage.textContent = 'Please enter your email address first.';
        return;
      }
      
      // Check if user has a cloud account
      const cloudUser = localStorage.getItem('cloudUser');
      
      if (cloudUser) {
        const userData = JSON.parse(cloudUser);
        if (userData.email === email) {
          // Show simple password reset for cloud accounts
          showSimplePasswordReset(email);
          return;
        }
      }
      
      // Check for local user and migrate
      const localUser = localStorage.getItem('localUser');
      if (localUser) {
        const userData = JSON.parse(localUser);
        if (userData.email === email) {
          // Migrate local user to cloud first
          console.log('Migrating local user to cloud for password reset');
          const password = localStorage.getItem('userPassword');
          localStorage.setItem('cloudUser', JSON.stringify(userData));
          localStorage.setItem('cloudAuth', 'true');
          localStorage.setItem('cloudPassword', password || '');
          
          // Clean up old local data
          localStorage.removeItem('localUser');
          localStorage.removeItem('localAuth');
          localStorage.removeItem('userPassword');
          
          // Show password reset for migrated cloud account
          showSimplePasswordReset(email);
          return;
        }
      }
      
      // For Supabase accounts, try the email reset
      try {
        loginMessage.textContent = 'Sending password reset email...';
        
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin
        });
        
        if (error) {
          console.error('Password reset error:', error);
          loginMessage.textContent = `Error: ${error.message}. Try creating a new account instead.`;
          return;
        }
        
        loginMessage.textContent = 'Password reset email sent! Check your inbox and spam folder.';
      } catch (err) {
        console.error('Unexpected error during password reset:', err);
        loginMessage.textContent = 'Email reset failed. Try creating a new account instead.';
      }
    }

    function showSimplePasswordReset(email) {
      // Create a simple password reset modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--card-bg);
          padding: 30px;
          border-radius: 12px;
          max-width: 400px;
          width: 90%;
          text-align: center;
          border: 1px solid var(--border-color);
        ">
          <h3>Reset Password</h3>
          <p>Enter your new password for: ${email}</p>
          <div style="margin: 20px 0;">
            <input type="password" id="new-password" placeholder="New Password" style="
              width: 100%;
              padding: 10px;
              margin: 10px 0;
              border: 1px solid var(--border-color);
              border-radius: 8px;
              background: var(--input-bg);
              color: var(--text-primary);
            ">
            <input type="password" id="confirm-password" placeholder="Confirm Password" style="
              width: 100%;
              padding: 10px;
              margin: 10px 0;
              border: 1px solid var(--border-color);
              border-radius: 8px;
              background: var(--input-bg);
              color: var(--text-primary);
            ">
          </div>
          <div>
            <button onclick="resetLocalPassword('${email}')" style="
              background: var(--button-gradient);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
              margin: 5px;
            ">Reset Password</button>
            <button onclick="closeResetModal()" style="
              background: #6b7280;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
              margin: 5px;
            ">Cancel</button>
          </div>
          <p id="reset-message" style="margin-top: 15px; color: var(--text-muted);"></p>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function closeResetModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }

    async function resetLocalPassword(email) {
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const messageEl = document.getElementById('reset-message');
      
      if (!newPassword || !confirmPassword) {
        messageEl.textContent = 'Please enter both passwords.';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        messageEl.textContent = 'Passwords do not match.';
        return;
      }
      
      if (newPassword.length < 6) {
        messageEl.textContent = 'Password must be at least 6 characters.';
        return;
      }
      
      try {
        // Only check cloud users
        const cloudUser = localStorage.getItem('cloudUser');
        
        if (cloudUser) {
          const userData = JSON.parse(cloudUser);
          if (userData.email === email) {
            userData.password = newPassword;
            localStorage.setItem('cloudUser', JSON.stringify(userData));
            localStorage.setItem('cloudPassword', newPassword);
            
            messageEl.textContent = '✅ Password reset successfully! You can now log in.';
            setTimeout(() => {
              closeResetModal();
            }, 2000);
          } else {
            messageEl.textContent = 'Account not found. Please sign up first.';
          }
        } else {
          messageEl.textContent = 'Account not found. Please sign up first.';
        }
        
      } catch (err) {
        console.error('Error resetting password:', err);
        messageEl.textContent = 'Error resetting password. Please try again.';
      }
    }

    async function testAuthConnection() {
      console.log('Testing auth connection...');
      try {
        const { data, error } = await supabase.auth.getSession();
        console.log('Auth test result:', { data, error });
        
        // Test if we can get auth settings
        const { data: settings } = await supabase.auth.getUser();
        console.log('User settings:', settings);
        
        alert(`Auth test: ${error ? 'Failed - ' + error.message : 'Success - ' + (data.session ? 'Session found' : 'No session')}`);
      } catch (err) {
        console.error('Auth test error:', err);
        alert('Auth test failed: ' + err.message);
      }
    }

    async function handleSignOut() {
      console.log('Sign out function called');
      console.log('Current user:', user);
      
      try {
        // Check if using cloud authentication
        const cloudAuth = localStorage.getItem('cloudAuth');
        
        if (cloudAuth === 'true') {
          // Cloud sign out
          console.log('Performing cloud sign out');
          user = null;
          reflections = [];
          localStorage.removeItem('reflections');
          localStorage.removeItem('cloudUser');
          localStorage.removeItem('cloudAuth');
          localStorage.removeItem('cloudPassword');
          document.getElementById('auth-button').classList.add('hidden');
          showRegisterScreen();
          console.log('Successfully signed out from cloud authentication');
          alert('Successfully signed out!');
        } else {
          // Supabase sign out
          console.log('Performing Supabase sign out');
          try {
            const { error } = await supabase.auth.signOut();
            if (error) {
              console.error('Supabase sign out error:', error);
              
              // Handle specific session error
              if (error.message.includes('Session from session_id claim in JWT does not exist')) {
                console.log('Session expired or invalid, performing local cleanup');
                // Force local cleanup even if Supabase session is invalid
                user = null;
                reflections = [];
                localStorage.removeItem('reflections');
                localStorage.removeItem('cloudUser');
                localStorage.removeItem('cloudAuth');
                localStorage.removeItem('cloudPassword');
                document.getElementById('auth-button').classList.add('hidden');
                showRegisterScreen();
                console.log('Successfully cleaned up local session');
                alert('Successfully signed out! (Session was already expired)');
                return;
              }
              
              alert('Failed to sign out from Supabase: ' + error.message);
              return;
            }
          } catch (signOutError) {
            console.error('Supabase sign out failed, performing local cleanup:', signOutError);
            // If Supabase sign out fails completely, still clean up locally
            user = null;
            reflections = [];
            localStorage.removeItem('reflections');
            localStorage.removeItem('cloudUser');
            localStorage.removeItem('cloudAuth');
            localStorage.removeItem('cloudPassword');
            document.getElementById('auth-button').classList.add('hidden');
            showRegisterScreen();
            console.log('Successfully cleaned up local session after Supabase error');
            alert('Successfully signed out! (Cleaned up local session)');
            return;
          }
          
          user = null;
          reflections = [];
          localStorage.removeItem('reflections');
          localStorage.removeItem('localUser');
          localStorage.removeItem('localAuth');
          document.getElementById('auth-button').classList.add('hidden');
          showRegisterScreen();
          console.log('Successfully signed out from Supabase');
          alert('Successfully signed out!');
        }
      } catch (err) {
        console.error('Unexpected error during sign out:', err);
        alert('An unexpected error occurred during sign out. Please try again.');
      }
    }

    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        // Test basic auth connection instead of database table
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('Supabase connection test failed:', error);
          return false;
        }
        console.log('Supabase connection successful');
        return true;
      } catch (err) {
        console.error('Supabase connection error:', err);
        return false;
      }
    }

    // Auto-sync function that runs periodically
    function startAutoSync() {
      // Auto-sync every 30 seconds if user is logged in
      setInterval(async () => {
        if (user && !document.getElementById('entry-screen').classList.contains('hidden')) {
          console.log('Auto-sync check...');
          try {
            const { data } = await supabase
              .from('reflections')
              .select('count')
              .eq('user_id', user.id);
            
            const localCount = reflections.length;
            const dbCount = data ? data.length : 0;
            
            if (Math.abs(localCount - dbCount) > 0) {
              console.log('Auto-sync: Data mismatch detected, refreshing...');
              await loadReflections();
              refreshHistoryDisplay();
            }
          } catch (err) {
            console.log('Auto-sync check failed:', err);
          }
        }
      }, 30000); // 30 seconds
    }

    // Check for verification token in URL
    function checkVerificationToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const verifyToken = urlParams.get('verify');
      
      if (verifyToken) {
        // Get pending user data
        const pendingUserData = localStorage.getItem('pendingUser');
        if (pendingUserData) {
          const pendingUser = JSON.parse(pendingUserData);
          
          // Check if token matches
          if (pendingUser.verificationToken === verifyToken) {
            // Mark as verified
            pendingUser.verified = true;
            localStorage.setItem('pendingUser', JSON.stringify(pendingUser));
            
            // Show success message
            alert('✅ Email verified successfully! You can now complete your account setup.');
            
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            return true;
          }
        }
      }
      return false;
    }

        // Initialize auth state
    async function initAuth() {
      try {
        console.log('=== INITIALIZING APP ===');
        console.log('LocalStorage contents:', Object.keys(localStorage));
        
        // Check if user is already logged in
        const savedUser = localStorage.getItem('currentUser');
        console.log('Saved user from localStorage:', savedUser);
        
        if (savedUser) {
          try {
            const parsedUser = JSON.parse(savedUser);
            console.log('Parsed user object:', parsedUser);
            console.log('User ID:', parsedUser.userId);
            
            // Migrate old format to proper UUID if needed
            currentUser = migrateUserToProperUUID(parsedUser);
            console.log('Final user object after migration:', currentUser);
            
            showMainScreen();
            await loadReflections();
            return;
          } catch (parseErr) {
            console.error('Error parsing saved user:', parseErr);
            localStorage.removeItem('currentUser');
          }
        }
        
        // No user logged in, show account screen
        console.log('No valid user found, showing account screen');
        showAccountScreen();
        
        // Check if there's shared data in URL
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');
        if (encodedData) {
          console.log('Found shared data in URL, will load after user login');
        }
        
      } catch (err) {
        console.error('Error initializing auth:', err);
        console.error('Error stack:', err.stack);
        // Show account screen on error
        showAccountScreen();
      }
    }

    // Event listeners
    document.getElementById('start-voice').addEventListener('click', startVoiceRecognition);
    document.getElementById('stop-voice').addEventListener('click', stopVoiceRecognition);
    document.getElementById('title').addEventListener('input', checkSaveEnabled);
    document.getElementById('reflection').addEventListener('input', checkSaveEnabled);
    document.getElementById('save').addEventListener('click', saveReflection);
    document.getElementById('image-input').addEventListener('change', previewImage);
    document.getElementById('signup-button').addEventListener('click', handleSignUp);
    document.getElementById('login-button').addEventListener('click', handleLogin);
    document.getElementById('auth-button').addEventListener('click', handleSignOut);

    // Load reflections and initialize auth on page load
    async function initializeApp() {
      console.log('Initializing app...');
      
      // Load theme first
      loadTheme();
      
      // Initialize Notion
      initializeNotion();
      
      await initAuth();
      startAutoSync(); // Start auto-sync
      setInterval(updateDateTime, 1000);
      updateDateTime();
    }
    
    // Wait for DOM and scripts to load
    function startApp() {
      // Give a little time for scripts to load
      setTimeout(() => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
          initializeApp();
        }
      }, 100);
    }
    
    startApp();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }
  </script>
</body>
</html>
